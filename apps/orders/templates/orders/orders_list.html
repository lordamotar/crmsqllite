{% extends 'base.html' %}
{% load static %}
{% load order_extras %}

{% block title %}Заказы - CRM{% endblock %}

{% block extra_css %}
<!-- Стили вынесены в static/frontend/assets/css/demo.css -->
<style>
  input[type="search"]::-webkit-search-cancel-button {
    -webkit-appearance: none;
    display: none;
  }
  input[type="search"]::-ms-clear {
    display: none;
  }
</style>
{% endblock %}

{% block content %}
<div class="container-xxl flex-grow-1 container-p-y">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h4 class="mb-0">Список заказов</h4>
    <a href="{% url 'orders:add_order' %}" class="btn btn-primary">
      <i class="icon-base ri ri-add-line me-1"></i>
      Создать заказ
    </a>
  </div>
  <div class="card">
    <div class="card-body">
      <!-- Пагинация сверху -->
      <div class="d-flex justify-content-between align-items-center mb-4">
        <div class="d-flex align-items-center">
          <span class="me-3">Показать:</span>
          <select name="per_page" class="form-select form-select-sm" style="width: auto;" onchange="changePerPage(this.value)">
            <option value="10" {% if per_page == 10 %}selected{% endif %}>10</option>
            <option value="25" {% if per_page == 25 %}selected{% endif %}>25</option>
            <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
            <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
          </select>
          <span class="ms-3 text-muted">
            Показано {{ orders.start_index }}-{{ orders.end_index }} из {{ orders.paginator.count }} записей
          </span>
        </div>
        <div class="d-flex align-items-center">
            <form method="get" class="d-inline">
              <div class="input-group">
                <input type="search" class="form-control form-control-sm" name="search" placeholder="Поиск по всем полям заказа" value="{{ request.GET.search }}" style="width: 300px;" autocomplete="off">
                <button class="btn btn-outline-primary btn-sm" type="submit">
                  <i class="ri-search-line"></i>
                </button>
              {% if request.GET.search %}
                <a href="{% url 'orders:orders_list' %}" class="btn btn-outline-secondary btn-sm">
                  <i class="ri-close-line"></i>
                </a>
              {% endif %}
              </div>
              <!-- Сохраняем другие параметры -->
              {% if request.GET.per_page %}
                <input type="hidden" name="per_page" value="{{ request.GET.per_page }}">
              {% endif %}
              {% if request.GET.sort %}
                <input type="hidden" name="sort" value="{{ request.GET.sort }}">
              {% endif %}
              {% if request.GET.order %}
                <input type="hidden" name="order" value="{{ request.GET.order }}">
              {% endif %}
            </form>
        </div>
  </div>

      <!-- Таблица заказов -->
      <div class="table-responsive">
        <table class="table table-hover table-sm">
          <thead class="table-dark sticky-top">
            <tr>
              <th style="min-width: 80px;">
                <div class="d-flex align-items-center">
                  Действия
                </div>
                <div class="resize-handle"></div>
              </th>
         <!--    <th style="min-width: 100px;">
                <div class="d-flex align-items-center">
                  <i class="ri-arrow-up-line me-1 text-muted" style="font-size: 12px;"></i>
                  <i class="ri-arrow-down-line me-2 text-muted" style="font-size: 12px;"></i>
                  ID заказа
                </div>
                <div class="resize-handle"></div>
              </th>--> 
              <th style="min-width: 150px;" data-sort="status">
                <div class="d-flex align-items-center">
                  <i class="ri-arrow-up-line me-1 text-muted sort-arrow" style="font-size: 12px; cursor: pointer;" data-direction="asc" onclick="handleSortClick(this)"></i>
                  <i class="ri-arrow-down-line me-2 text-muted sort-arrow" style="font-size: 12px; cursor: pointer;" data-direction="desc" onclick="handleSortClick(this)"></i>
                  Статус
                </div>
                <div class="resize-handle"></div>
              </th>
              <th style="min-width: 120px;" data-sort="created_at">
                <div class="d-flex align-items-center">
                  <i class="ri-arrow-up-line me-1 text-muted sort-arrow" style="font-size: 12px; cursor: pointer;" data-direction="asc" onclick="handleSortClick(this)"></i>
                  <i class="ri-arrow-down-line me-2 text-muted sort-arrow" style="font-size: 12px; cursor: pointer;" data-direction="desc" onclick="handleSortClick(this)"></i>
                  Дата создания
                </div>
                <div class="resize-handle"></div>
              </th>
              <th style="min-width: 120px;" data-sort="responsible">
                <div class="d-flex align-items-center">
                  <i class="ri-arrow-up-line me-1 text-muted sort-arrow" style="font-size: 12px; cursor: pointer;" data-direction="asc" onclick="handleSortClick(this)"></i>
                  <i class="ri-arrow-down-line me-2 text-muted sort-arrow" style="font-size: 12px; cursor: pointer;" data-direction="desc" onclick="handleSortClick(this)"></i>
                  Ответственный
                </div>
                <div class="resize-handle"></div>
              </th>
              <th style="min-width: 250px;" data-sort="client">
                <div class="d-flex align-items-center">
                  Клиент
                </div>
                <div class="resize-handle"></div>
              </th>
              <th style="min-width: 120px;" data-sort="client__addresses__city">
                <div class="d-flex align-items-center">
                  <i class="ri-arrow-up-line me-1 text-muted sort-arrow" style="font-size: 12px; cursor: pointer;" data-direction="asc" onclick="handleSortClick(this)"></i>
                  <i class="ri-arrow-down-line me-2 text-muted sort-arrow" style="font-size: 12px; cursor: pointer;" data-direction="desc" onclick="handleSortClick(this)"></i>
                  Город клиента
                </div>
                <div class="resize-handle"></div>
              </th>
              <th style="min-width: 120px;" data-sort="items__branch_city">
                <div class="d-flex align-items-center">
                  <i class="ri-arrow-up-line me-1 text-muted sort-arrow" style="font-size: 12px; cursor: pointer;" data-direction="asc" onclick="handleSortClick(this)"></i>
                  <i class="ri-arrow-down-line me-2 text-muted sort-arrow" style="font-size: 12px; cursor: pointer;" data-direction="desc" onclick="handleSortClick(this)"></i>
                  Город филиал
                </div>
                <div class="resize-handle"></div>
              </th>
              <th style="min-width: 100px;">
                <div class="d-flex align-items-center">
                  Код товара
                </div>
                <div class="resize-handle"></div>
              </th>
              <th style="min-width: 120px;">
                <div class="d-flex align-items-center">
                  Тип шины / Сегмент
                </div>
                <div class="resize-handle"></div>
              </th>
              <th style="min-width: 300px;">
                <div class="d-flex align-items-center">
                  Номенклатура
                </div>
                <div class="resize-handle"></div>
              </th>
              <th style="min-width: 100px;">
                <div class="d-flex align-items-center">
                  Цена
                </div>
                <div class="resize-handle"></div>
              </th>
              <th style="min-width: 80px;">
                <div class="d-flex align-items-center">
                  Кол-во
                </div>
                <div class="resize-handle"></div>
              </th>
              <th style="min-width: 120px;">
                <div class="d-flex align-items-center">
                  Сумма
                </div>
                <div class="resize-handle"></div>
              </th>
              <th style="min-width: 120px;">
                <div class="d-flex align-items-center">
                  Откуда заказ
                </div>
                <div class="resize-handle"></div>
              </th>
              <th style="min-width: 120px;">
                <div class="d-flex align-items-center">
                  Способ оплаты
                </div>
                <div class="resize-handle"></div>
              </th>
              <th style="min-width: 120px;">
                <div class="d-flex align-items-center">
                  Способ доставки
                </div>
                <div class="resize-handle"></div>
              </th>
              <th style="min-width: 100px;">
                <div class="d-flex align-items-center">
                  Уровень цен
                </div>
                <div class="resize-handle"></div>
              </th>
              <th style="min-width: 80px;">
                <div class="d-flex align-items-center">
                  По акции
                </div>
                <div class="resize-handle"></div>
              </th>
              <th style="min-width: 120px;">
                <div class="d-flex align-items-center">                
                  Комментарий
                </div>
                <div class="resize-handle"></div>
              </th>
            </tr>
          </thead>
          <tbody class="table-border-bottom-0">
            {% for order in orders %}
              {% for item in order.items.all %}
                <tr class="status-{{ order.status|status_css_class }}" data-status="{{ order.status }}" data-css-class="{{ order.status|status_css_class }}">
                  {% if forloop.first %}
                    <td rowspan="{{ order.items.count }}">
                      <a href="{% url 'orders:edit_order' order.id %}" class="btn btn-sm btn-outline-primary">
                        <i class="ri-edit-line"></i>
                      </a>
                    </td>
                  <!--  <td rowspan="{{ order.items.count }}">{{ order.order_number }}</td>-->
                    <td rowspan="{{ order.items.count }}">
                      <div class="dropdown order-status-dropdown" data-order-id="{{ order.id }}">
                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle w-100 d-flex align-items-center justify-content-between {{ order.status|status_text_class }}" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                          <span class="d-flex align-items-center">
                            <i class="icon-base ri ri-circle-fill icon-10px me-1"></i>
                            <span class="order-status-text">{{ order.get_status_display }}</span>
                          </span>
                        </button>
                        <ul class="dropdown-menu">
                          <li class="dropdown-header">Новые</li>
                          <li><a class="dropdown-item{% if order.status == 'new' %} active{% endif %}" href="#" data-status-value="new">Новый</a></li>
                          <li><a class="dropdown-item{% if order.status == 'new_paid' %} active{% endif %}" href="#" data-status-value="new_paid">Новый оплаченный</a></li>
                          <li><hr class="dropdown-divider"></li>
                          <li class="dropdown-header">Промежуточные</li>
                          <li><a class="dropdown-item{% if order.status == 'reserve' %} active{% endif %}" href="#" data-status-value="reserve">Резерв</a></li>
                          <li><a class="dropdown-item{% if order.status == 'transfer' %} active{% endif %}" href="#" data-status-value="transfer">Перемещение</a></li>
                          <li><a class="dropdown-item{% if order.status == 'delivery' %} active{% endif %}" href="#" data-status-value="delivery">Доставка</a></li>
                          <li><a class="dropdown-item{% if order.status == 'callback' %} active{% endif %}" href="#" data-status-value="callback">Перезвонить</a></li>
                          <li><hr class="dropdown-divider"></li>
                          <li class="dropdown-header">Завершённые</li>
                          <li><a class="dropdown-item{% if order.status == 'completed' %} active{% endif %}" href="#" data-status-value="completed">Выполнен</a></li>
                          <li><a class="dropdown-item text-danger" href="#" data-status-value="cancelled">Отмена…</a></li>
                          <li><hr class="dropdown-divider"></li>
                          <li class="dropdown-header">Отмена — причины</li>
                          <li><a class="dropdown-item{% if order.status == 'refund' %} active{% endif %}" href="#" data-status-value="refund">Возврат товара/средств</a></li>
                          <li><a class="dropdown-item{% if order.status == 'cancel_no_answer' %} active{% endif %}" href="#" data-status-value="cancel_no_answer">Не дозвонился</a></li>
                          <li><a class="dropdown-item{% if order.status == 'cancel_not_suitable_year' %} active{% endif %}" href="#" data-status-value="cancel_not_suitable_year">Не устроил год</a></li>
                          <li><a class="dropdown-item{% if order.status == 'cancel_wrong_order' %} active{% endif %}" href="#" data-status-value="cancel_wrong_order">Ошибочный заказ</a></li>
                          <li><a class="dropdown-item{% if order.status == 'cancel_found_other' %} active{% endif %}" href="#" data-status-value="cancel_found_other">Нашел другие шины</a></li>
                          <li><a class="dropdown-item{% if order.status == 'cancel_delivery_terms' %} active{% endif %}" href="#" data-status-value="cancel_delivery_terms">Условия доставки</a></li>
                          <li><a class="dropdown-item{% if order.status == 'cancel_no_quantity' %} active{% endif %}" href="#" data-status-value="cancel_no_quantity">Нет нужного количества</a></li>
                          <li><a class="dropdown-item{% if order.status == 'cancel_incomplete' %} active{% endif %}" href="#" data-status-value="cancel_incomplete">Не комплект (не собран)</a></li>
                        </ul>
                      </div>
                    </td>
                    <td rowspan="{{ order.items.count }}">{{ order.created_at|date:"d.m.Y" }}</td>
                    <td rowspan="{{ order.items.count }}">
                      {% if order.responsible.last_name %}
                        {{ order.responsible.last_name }} {{ order.responsible.first_name|slice:":1" }}.{% if order.responsible.middle_name %}{{ order.responsible.middle_name|slice:":1" }}.{% endif %}
                      {% else %}
                        {{ order.responsible.username }}
                      {% endif %}
                    </td>
                    <td rowspan="{{ order.items.count }}">
                      <div class="d-flex align-items-start">
                        <div class="me-2 mt-1">
                          {% if order.client.client_type == 'individual' %}
                            <i class="ri-user-line text-success"></i>
                          {% else %}
                            <i class="ri-user-2-line text-danger"></i>
                          {% endif %}
                        </div>
                        <div class="flex-grow-1">
                          <div class="mb-1">
                            {% if order.client.client_type == 'individual' %}
                              {% if order.client.individual_data %}
                                <strong>{{ order.client.individual_data.last_name }} {{ order.client.individual_data.first_name }} {{ order.client.individual_data.middle_name }}</strong>
                              {% endif %}
                            {% else %}
                              {% if order.client.legal_entity_data %}
                                <strong>{{ order.client.legal_entity_data.company_name }}</strong>
                              {% endif %}
                            {% endif %}
                          </div>
                          <div class="text-muted small">
                            {% if order.client.phones.first %}
                              <i class="ri-phone-line me-1"></i>{{ order.client.phones.first.phone|format_phone }}
                            {% else %}
                              <span class="text-muted">Телефон не указан</span>
                            {% endif %}
                          </div>
                        </div>
                      </div>
                    </td>
                    <td rowspan="{{ order.items.count }}">
                      {% if order.client.addresses.first %}
                        {{ order.client.addresses.first.city }}
                      {% else %}
                        <span class="text-muted">-</span>
                      {% endif %}
                    </td>
                    <td>{{ item.branch_city }}</td>
                    <td>{{ item.product_code }}</td>
                    <td>
                      {% if item.segment and item.tire_type %}
                        {{ item.segment }} • {{ item.tire_type }}
                      {% elif item.segment %}
                        {{ item.segment }}
                      {% elif item.tire_type %}
                        {{ item.tire_type }}
                      {% else %}
                        —
                      {% endif %}
                    </td>
                    <td>{{ item.product_name }}</td>
                    <td>{{ item.price|spaced_thousands }}</td>
                    <td>{{ item.quantity }}</td>
                    <td rowspan="{{ order.items.count }}">{{ order.total_amount|spaced_thousands }}</td>
                    <td rowspan="{{ order.items.count }}">
                      <h6 class="mb-0 align-items-center d-flex w-px-100 {{ order.source|source_text_class }}">
                        <i class="icon-base ri ri-circle-fill icon-10px me-1"></i>{{ order.source|source_display }}
                      </h6>
                    </td>
                    <td rowspan="{{ order.items.count }}">
                      <h6 class="mb-0 align-items-center d-flex w-px-100 {{ order.payment_method|payment_method_text_class }}">
                        <i class="icon-base ri ri-circle-fill icon-10px me-1"></i>{{ order.payment_method|payment_method_display }}
                      </h6>
                    </td>
                    <td rowspan="{{ order.items.count }}">{{ order.get_delivery_method_display }}</td>
                    <td rowspan="{{ order.items.count }}">
                      <span class="badge bg-{% if order.price_level == 'wholesale' %}primary{% elif order.price_level == 'promotional' %}warning{% else %}success{% endif %}">
                        {{ order.get_price_level_display }}
                      </span>
                    </td>
                    <td rowspan="{{ order.items.count }}">
                      {% if order.is_promo %}
                        <i class="ri-check-line text-success"></i>
                      {% else %}
                        <i class="ri-close-line text-muted"></i>
                      {% endif %}
              </td>
                    <td rowspan="{{ order.items.count }}">{{ order.notes|default:"" }}</td>
                  {% else %}
                    <td>{{ item.branch_city }}</td>
                    <td>{{ item.product_code }}</td>
                    <td>
                      {% if item.segment and item.tire_type %}
                        {{ item.segment }} • {{ item.tire_type }}
                      {% elif item.segment %}
                        {{ item.segment }}
                      {% elif item.tire_type %}
                        {{ item.tire_type }}
                      {% else %}
                        —
                      {% endif %}
                    </td>
                    <td>{{ item.product_name }}</td>
                    <td>{{ item.price|spaced_thousands }}</td>
                    <td>{{ item.quantity }}</td>
                  {% endif %}
                </tr>
              {% empty %}
                <tr class="status-{{ order.status|status_css_class }}" data-status="{{ order.status }}" data-css-class="{{ order.status|status_css_class }}">
                  <td>
                    <a href="{% url 'orders:edit_order' order.id %}" class="btn btn-sm btn-outline-primary">
                      <i class="ri-edit-line"></i>
                    </a>
                  </td>
                  <!--  <td>{{ order.order_number }}</td>-->
                  <td>
                    <h6 class="mb-0 align-items-center d-flex w-px-100 {{ order.status|status_text_class }}">
                      <i class="icon-base ri ri-circle-fill icon-10px me-1"></i>{{ order.get_status_display }}
                    </h6>
                  </td>
                  <td>{{ order.created_at|date:"d.m.Y" }}</td>
                  <td>
                    {% if order.responsible.last_name %}
                      {{ order.responsible.last_name }} {{ order.responsible.first_name|slice:":1" }}.{% if order.responsible.middle_name %}{{ order.responsible.middle_name|slice:":1" }}.{% endif %}
                    {% else %}
                      {{ order.responsible.username }}
                    {% endif %}
                  </td>
                  <td>
                    <div class="d-flex align-items-start">
                      <div class="me-2 mt-1">
                        {% if order.client.client_type == 'individual' %}
                          <i class="ri-user-line text-success"></i>
                        {% else %}
                          <i class="ri-user-2-line text-danger"></i>
                        {% endif %}
                      </div>
                      <div class="flex-grow-1">
                        <div class="mb-1">
                          {% if order.client.client_type == 'individual' %}
                            {% if order.client.individual_data %}
                              <strong>{{ order.client.individual_data.last_name }} {{ order.client.individual_data.first_name }} {{ order.client.individual_data.middle_name }}</strong>
                            {% endif %}
                          {% else %}
                            {% if order.client.legal_entity_data %}
                              <strong>{{ order.client.legal_entity_data.company_name }}</strong>
                            {% endif %}
                          {% endif %}
                        </div>
                        <div class="text-muted small">
                          {% if order.client.phones.first %}
                            <i class="ri-phone-line me-1"></i>{{ order.client.phones.first.phone|format_phone }}
                          {% else %}
                            <span class="text-muted">Телефон не указан</span>
                          {% endif %}
                        </div>
                      </div>
                    </div>
                  </td>
                  <td>
                    {% if order.client.addresses.first %}
                      {{ order.client.addresses.first.city }}
                    {% else %}
                      <span class="text-muted">-</span>
                    {% endif %}
                  </td>
                  <td colspan="3"></td>
                  <td>{{ order.total_amount|spaced_thousands }}</td>
                  <td>
                    <h6 class="mb-0 align-items-center d-flex w-px-100 {{ order.source|source_text_class }}">
                      <i class="icon-base ri ri-circle-fill icon-10px me-1"></i>{{ order.source|source_display }}
                    </h6>
                  </td>
                  <td>
                    <h6 class="mb-0 align-items-center d-flex w-px-100 {{ order.payment_method|payment_method_text_class }}">
                      <i class="icon-base ri ri-circle-fill icon-10px me-1"></i>{{ order.payment_method|payment_method_display }}
                    </h6>
                  </td>
                  <td>{{ order.get_delivery_method_display }}</td>
                  <td>
                    {% if order.is_promo %}
                      <i class="ri-check-line text-success"></i>
                    {% else %}
                      <i class="ri-close-line text-muted"></i>
                    {% endif %}
                  </td>
                  <td>{{ order.notes|default:"" }}</td>
                </tr>
              {% endfor %}
            {% empty %}
              <tr>
                <td colspan="17" class="text-center text-muted py-4">
                  <i class="ri-inbox-line me-2"></i>
                  Заказы не найдены
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Пагинация внизу -->
      <nav aria-label="Page navigation" class="mt-4">
        <ul class="pagination justify-content-center">
          {% if orders.has_previous %}
            <li class="page-item">
              <a class="page-link" href="?page=1{% if per_page %}&per_page={{ per_page }}{% endif %}">Первая</a>
            </li>
            <li class="page-item">
              <a class="page-link" href="?page={{ orders.previous_page_number }}{% if per_page %}&per_page={{ per_page }}{% endif %}">Предыдущая</a>
            </li>
          {% endif %}

          {% for num in orders.paginator.page_range %}
            {% if num == orders.number %}
              <li class="page-item active">
                <span class="page-link">{{ num }}</span>
              </li>
            {% elif num > orders.number|add:'-3' and num < orders.number|add:'3' %}
              <li class="page-item">
                <a class="page-link" href="?page={{ num }}{% if per_page %}&per_page={{ per_page }}{% endif %}">{{ num }}</a>
              </li>
            {% endif %}
          {% endfor %}

          {% if orders.has_next %}
            <li class="page-item">
              <a class="page-link" href="?page={{ orders.next_page_number }}{% if per_page %}&per_page={{ per_page }}{% endif %}">Следующая</a>
            </li>
            <li class="page-item">
              <a class="page-link" href="?page={{ orders.paginator.num_pages }}{% if per_page %}&per_page={{ per_page }}{% endif %}">Последняя</a>
            </li>
      {% endif %}
        </ul>
      </nav>
    </div>
  </div>
</div>

<script>
function changePerPage(value) {
  const url = new URL(window.location);
  url.searchParams.set('per_page', value);
  url.searchParams.set('page', '1');
  window.location.href = url.toString();
}

function handleSortClick(arrow) {
  const direction = arrow.getAttribute('data-direction');
  const th = arrow.closest('th');
  const sortField = th.getAttribute('data-sort');
  
  if (!sortField) return;
  
  const urlParams = new URLSearchParams(window.location.search);
  urlParams.set('sort', sortField);
  urlParams.set('order', direction);
  
  const newUrl = `${window.location.pathname}?${urlParams.toString()}`;
  window.location.href = newUrl;
}

function handleSearch() {
  console.log('handleSearch вызвана');
  const searchInput = document.getElementById('order-search');
  const searchValue = searchInput.value.trim();
  
  console.log('Значение поиска:', searchValue);
  
  const urlParams = new URLSearchParams(window.location.search);
  
  if (searchValue) {
    urlParams.set('search', searchValue);
  } else {
    urlParams.delete('search');
  }
  
  // Сбрасываем на первую страницу при поиске
  urlParams.set('page', '1');
  
  const newUrl = `${window.location.pathname}?${urlParams.toString()}`;
  console.log('Переход на URL:', newUrl);
  window.location.href = newUrl;
}

function clearSearch() {
  const urlParams = new URLSearchParams(window.location.search);
  urlParams.delete('search');
  urlParams.set('page', '1');
  
  const newUrl = `${window.location.pathname}?${urlParams.toString()}`;
  window.location.href = newUrl;
}

// Обработка Enter в поле поиска
document.addEventListener('DOMContentLoaded', function() {
  console.log('DOM загружен, инициализация поиска...');
  const searchInput = document.getElementById('order-search');
  console.log('Поле поиска найдено:', searchInput);
  
  if (searchInput) {
    searchInput.addEventListener('keypress', function(e) {
      console.log('Клавиша нажата:', e.key);
      if (e.key === 'Enter') {
        console.log('Enter нажат, вызываем handleSearch');
        handleSearch();
      }
    });
  }

  // Inline смена статуса заказа
  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
  }

  document.body.addEventListener('click', function(e) {
    const item = e.target.closest('.order-status-dropdown .dropdown-item');
    if (!item) return;
    e.preventDefault();

    const dropdown = item.closest('.order-status-dropdown');
    const orderId = dropdown.getAttribute('data-order-id');
    const newStatus = item.getAttribute('data-status-value');
    if (!orderId || !newStatus) return;

    // Если выбрана "Отмена…" — открываем модал выбора причины и выходим
    if (newStatus === 'cancelled') {
      const cancelModalEl = document.getElementById('cancelReasonModal');
      const reasonSelect = document.getElementById('cancelReasonSelectList');
      const confirmBtn = document.getElementById('confirmCancelReasonBtn');
      if (reasonSelect) reasonSelect.value = '';
      const modal = new bootstrap.Modal(cancelModalEl);
      modal.show();

      // Навешиваем одноразовый обработчик подтверждения
      const onConfirm = () => {
        const reason = reasonSelect ? reasonSelect.value : '';
        if (!reason) {
          if (window.showNotification) window.showNotification('Выберите причину отмены', 'error');
          return;
        }
        // Подменяем статус на конкретную причину и отправляем
        postStatus(orderId, reason, dropdown, item);
        modal.hide();
        confirmBtn.removeEventListener('click', onConfirm);
      };
      confirmBtn.addEventListener('click', onConfirm);
      return;
    }

    // Иначе — отправляем выбранный статус
    postStatus(orderId, newStatus, dropdown, item);
  });

  function postStatus(orderId, statusValue, dropdown, item){
    fetch('{% url "orders:update_order_status" %}', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      },
      body: JSON.stringify({ order_id: orderId, status: statusValue })
    })
    .then(r => r.json())
    .then(data => {
      if (data.status !== 'success') {
        if (window.showNotification) window.showNotification(data.message || 'Ошибка обновления статуса', 'error');
        return;
      }
      const btn = dropdown.querySelector('button');
      const textEl = dropdown.querySelector('.order-status-text');
      textEl.textContent = data.status_display || statusValue;
      btn.classList.remove('text-success', 'text-warning', 'text-danger', 'text-primary', 'text-muted');
      if (data.text_class) btn.classList.add(data.text_class);
      const tr = dropdown.closest('tr');
      if (tr) {
        tr.className = tr.className.replace(/status-[^\s]+/, '');
        if (data.css_class) tr.classList.add(`status-${data.css_class}`);
      }
      dropdown.querySelectorAll('.dropdown-item').forEach(a => a.classList.remove('active'));
      if (item) item.classList.add('active');
      if (window.showNotification) window.showNotification('Статус обновлён', 'success');
    })
    .catch(() => {
      if (window.showNotification) window.showNotification('Сетевая ошибка', 'error');
    });
  }
});
</script>

<!-- JavaScript вынесен в static/frontend/assets/js/orders-list.js -->
<script src="{% static 'frontend/assets/js/orders-list.js' %}"></script>
<!-- Модал выбора причины отмены -->
<div class="modal fade" id="cancelReasonModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Указать причину отмены</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-2">
          <label class="form-label">Причина отмены</label>
          <select id="cancelReasonSelectList" class="form-control">
            <option value="">— Выберите причину —</option>
            <option value="refund">Возврат товара/средств</option>
            <option value="cancel_no_answer">Не дозвонился</option>
            <option value="cancel_not_suitable_year">Не устроил год</option>
            <option value="cancel_wrong_order">Ошибочный заказ</option>
            <option value="cancel_found_other">Нашел другие шины</option>
            <option value="cancel_delivery_terms">Условия доставки</option>
            <option value="cancel_no_quantity">Нет нужного количества</option>
            <option value="cancel_incomplete">Не комплект (не собран)</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-label-secondary" data-bs-dismiss="modal">Отмена</button>
        <button type="button" class="btn btn-danger" id="confirmCancelReasonBtn">
          <i class="ri-close-circle-line me-1"></i>Подтвердить отмену
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %}
