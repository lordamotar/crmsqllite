{% extends 'base.html' %}
{% load static %}

{% block title %}{% if is_edit %}Редактировать заказ{% else %}Создать заказ{% endif %}{% endblock %}

{% block content %}
<div class="container-xxl flex-grow-1 container-p-y" 
     data-product-search-url="{% url 'orders:product_search' %}"
     data-client-lookup-url="{% url 'orders:client_lookup' %}"
     data-add-order-url="{% url 'orders:add_order' %}"
     data-orders-list-url="{% url 'orders:orders_list' %}"
     data-add-client-url="{% url 'clients:add_client' %}"
     {% if is_edit and order %}data-edit-order-url="{% url 'orders:edit_order' order.id %}"{% endif %}
     data-is-edit="{% if is_edit %}true{% else %}false{% endif %}">
  <div class="d-flex justify-content-between align-items-center mb-6">
    <h4 class="mb-0">{% if is_edit %}Редактирование заказа{% else %}Создание заказа{% endif %}</h4>
    <a href="{% url 'orders:orders_list' %}" class="btn btn-label-secondary">
      <i class="icon-base ri ri-arrow-left-line me-1"></i>
      Назад к списку
    </a>
  </div>

  <div class="card">
    <div class="card-body">
      <ul class="nav nav-pills nav-fill mb-6 bg-light p-2 rounded" id="stepsNav">
        <li class="nav-item">
          <button class="nav-link active d-flex align-items-center justify-content-center py-3" data-step="1">
            <i class="ri-shopping-cart-line me-2"></i>
            <span>Шаг 1: Товары</span>
          </button>
        </li>
        <li class="nav-item">
          <button class="nav-link d-flex align-items-center justify-content-center py-3" data-step="2">
            <i class="ri-user-line me-2"></i>
            <span>Шаг 2: Клиент</span>
          </button>
        </li>
        <li class="nav-item">
          <button class="nav-link d-flex align-items-center justify-content-center py-3" data-step="3">
            <i class="ri-settings-line me-2"></i>
            <span>Шаг 3: Параметры</span>
          </button>
        </li>
        {% if is_edit %}
        <li class="nav-item">
          <button class="nav-link d-flex align-items-center justify-content-center py-3" data-step="4">
            <i class="ri-history-line me-2"></i>
            <span>История</span>
          </button>
        </li>
        {% endif %}
      </ul>

      <div id="step-1" class="step">
        <div class="row g-4 align-items-end">
          <div class="col-md-2">
            <label class="form-label fw-semibold">
              <i class="ri-money-dollar-circle-line me-1"></i>
              Цена
            </label>
            <input id="productPrice" type="number" class="form-control form-control-sm" step="0.01" placeholder="0.00" />
          </div>
          <div class="col-md-2">
            <label class="form-label fw-semibold">
              <i class="ri-hashtag me-1"></i>
              Кол-во
            </label>
            <input id="productQty" type="number" class="form-control form-control-sm" value="0" min="1" />
          </div>
          <div class="col-md-2">
            <label class="form-label fw-semibold">
              <i class="ri-price-tag-3-line me-1"></i>
              Уровень цен
            </label>
            <select id="priceLevelSelect" class="form-control form-control-sm">
              <option value="retail">Розничная</option>
              <option value="promotional">Акционная</option>
              <option value="wholesale">Оптовая</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label fw-semibold">
              <i class="ri-map-pin-line me-1"></i>
              Город
            </label>
            <select id="productCitySelect" class="form-control">
              <option value="">— Выберите город —</option>
              <option value="Актобе">Актобе</option>
              <option value="Алматы">Алматы</option>
              <option value="Астана">Астана</option>
              <option value="Караганда">Караганда</option>
              <option value="Павлодар">Павлодар</option>
              <option value="Петропавловск">Петропавловск</option>
              <option value="Семей">Семей</option>
              <option value="Усть-Каменогорск">Усть-Каменогорск</option>
              <option value="Шымкент">Шымкент</option>
              <option value="Уральск">Уральск</option>
              <option value="Кызылорда">Кызылорда</option>
              <option value="Центральный Склад">Центральный Склад</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label fw-semibold">
              <i class="ri-building-line me-1"></i>
              Филиал
            </label>
            <input id="productBranch" type="text" class="form-control" readonly />
          </div>
        </div>
        <!-- Расширенный поиск и фильтры -->
        <div class="row g-4 align-items-end mt-2">
          <div class="col-md-3">
            <label class="form-label fw-semibold"><i class="ri-barcode-line me-1"></i> Код / название</label>
            <input id="productSearchInput" type="text" class="form-control" placeholder="Код или название" />
          </div>

          <div class="col-md-2">
            <label class="form-label fw-semibold"><i class="ri-stack-line me-1"></i> Название</label>
            <input id="productNameInput" type="text" class="form-control" placeholder="Напр. Nokian Hakkapeliitta" />
          </div>

          <div class="col-md-2">
            <label class="form-label fw-semibold"><i class="ri-snowy-line me-1"></i> Сезон</label>
            <select id="productSeasonSelect" class="form-control">
              <option value="">Все</option>
              <option value="ЗИМ">ЗИМ — Зимние</option>
              <option value="ШИП">ШИП — Шипованные</option>
              <option value="ВС">ВС — Всесезонные</option>
              <option value="ДР">ДР — Летние</option>
              <option value="ПП">ПП — Повышенной проходимости</option>
              <option value="УВ">УВ — Универсальные</option>
              <option value="РУО">РУО — Рулевые</option>
              <option value="ВДО">ВДО — Ведущие</option>
              <option value="ПРО">ПРО — Прицепные</option>
              <option value="КАР">КАР — Карьерный</option>
              <option value="Без рисунка">Без рисунка</option>
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label fw-semibold"><i class="ri-map-pin-line me-1"></i> Город (фильтр)</label>
            <select id="productSearchCity" class="form-control">
              <option value="">Любой</option>
              <option value="Актобе">Актобе</option>
              <option value="Алматы">Алматы</option>
              <option value="Астана">Астана</option>
              <option value="Караганда">Караганда</option>
              <option value="Павлодар">Павлодар</option>
              <option value="Петропавловск">Петропавловск</option>
              <option value="Семей">Семей</option>
              <option value="Усть-Каменогорск">Усть-Каменогорск</option>
              <option value="Шымкент">Шымкент</option>
              <option value="Уральск">Уральск</option>
              <option value="Кызылорда">Кызылорда</option>
              <option value="Центральный Склад">Центральный Склад</option>
            </select>
          </div>
          <div class="col-md-2 d-flex align-items-end">
            <button id="productFindBtn" class="btn btn-primary w-100">Найти</button>
          </div>
        </div>

        <!-- Результаты поиска -->
        <div class="table-responsive border rounded mt-3" id="productResultsWrapper" style="display:none;">
          <table class="table table-hover mb-0" id="productResultsTable">
            <thead class="table-light">
              <tr>
                <th>Код</th>
                <th>Номенклатура</th>
                <th>Сезон</th>
                <th>Город</th>
                <th class="text-end">Цена</th>
                <th class="text-center">Уровни</th>
                <th class="text-center">Действие</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          <div class="p-3 text-end small text-muted">Выберите позицию и нажмите «Добавить» для корзины.</div>
        </div>
        <hr class="my-5" />
        <div class="table-responsive border rounded">
          <table class="table table-hover mb-0" id="itemsTable">
            <thead class="table-light">
              <tr>
                <th class="border-0">Код</th>
                <th class="border-0">Номенклатура</th>
                <th class="border-0">Город</th>
                <th class="text-end border-0">Цена</th>
                <th class="text-center border-0">Кол-во</th>
                <th class="text-end border-0">Сумма</th>
                <th class="text-center border-0" width="80">Действия</th>
              </tr>
            </thead>
            <tbody></tbody>
            <tfoot class="table-light">
              <tr>
                <td colspan="5" class="text-end border-0"><strong>Итого:</strong></td>
                <td class="text-end" id="totalCell"><strong>₸0</strong></td>
                <td></td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>

      <div id="step-2" class="step d-none">
        <div class="row g-4">
          <div class="col-md-4">
            <label class="form-label fw-semibold">
              <i class="ri-phone-line me-1"></i>
              Телефон
            </label>
            <input id="clientPhoneInput" type="tel" class="form-control" placeholder="+7 (___) ___-__-__" />
          </div>

          <div class="col-md-6">
            <label class="form-label fw-semibold">
              <i class="ri-user-line me-1"></i>
              Клиент
            </label>
            <select id="clientSelect" class="form-control">
              <option value="">— Выберите клиента —</option>
              {% for c in clients %}
              <option value="{{ c.id }}">{{ c.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label">&nbsp;</label>
            <button type="button" class="btn btn-outline-primary w-100 d-flex align-items-center justify-content-center py-2" data-bs-toggle="modal" data-bs-target="#addClientModal">
              <i class="ri-add-line me-2"></i>
              <span>Новый</span>
            </button>
          </div>

          <div class="col-md-6">
            <label class="form-label">ФИО / Название</label>
            <input id="clientNameInput" type="text" class="form-control" placeholder="Введите ФИО или название" />
          </div>
          <div class="col-md-6">
            <label class="form-label">Город</label>
            <input id="clientCityInput" type="text" class="form-control" placeholder="Введите город" />
          </div>

          <div class="col-12">
            <label class="form-label">Адрес / Комментарий</label>
            <textarea id="clientAddressComment" class="form-control" rows="3" placeholder="Адрес и дополнительные комментарии"></textarea>
          </div>
        </div>
      </div>

      <div id="step-3" class="step d-none">
        <div class="row g-4">
          <div class="col-md-4">
            <label class="form-label">Статус</label>
            <select id="statusSelect" class="form-control">
              <optgroup label="НОВЫЕ">
                <option value="new">Новый</option>
                <option value="new_paid">Новый оплаченный</option>
              </optgroup>
            
              <optgroup label="ПРОМЕЖУТОЧНЫЕ">
                <option value="reserve">Резерв</option>
                <option value="transfer">Перемещение</option>
                <option value="delivery">Доставка</option>
                <option value="callback">Перезвонить</option>
              </optgroup>
            
              <optgroup label="ЗАВЕРШЕННЫЕ">
                <option value="completed">Выполнен</option>
                <option value="cancelled">Отмена</option>
              </optgroup>
            </select>
            <!-- Блок выбора причины отмены (показывается при выборе "Отмена") -->
            <div id="cancelReasonWrapper" class="mt-2 d-none">
              <label class="form-label">Причина отмены</label>
              <select id="cancelReasonSelect" class="form-control">
                <option value="">— Выберите причину —</option>
                <option value="refund">Возврат товара/средств</option>
                <option value="cancel_no_answer">Не дозвонился</option>
                <option value="cancel_not_suitable_year">Не устроил год</option>
                <option value="cancel_wrong_order">Ошибочный заказ</option>
                <option value="cancel_found_other">Нашел другие шины</option>
                <option value="cancel_delivery_terms">Условия доставки</option>
                <option value="cancel_no_quantity">Нет нужного количества</option>
                <option value="cancel_incomplete">Не комплект (не собран)</option>
              </select>
            </div>
            
          </div>
          <div class="col-md-4">
            <label class="form-label">Откуда заказ</label>
            <select id="sourceSelect" class="form-control">
              <option value="callcentr">2710</option>
              <option value="2gis">2GIS WhatsApp</option>
              <option value="email">E-mail</option>
              <option value="instagram">Instagram</option>
              <option value="kaspi">Kaspi</option>
              <option value="whatsapp">Whatsapp</option>  
              <option value="website">Сайт</option>   
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Способ оплаты</label>
            <select id="paymentSelect" class="form-control">
              <option value="airba">Airba pay</option>
              <option value="halyk">Halyk</option>
              <option value="kaspi">Kaspi</option>
              <option value="woopay">Wooppay</option>
              <option value="bcc"> БЦК</option>
              <option value="cassa"> На кассе</option>
              <option value="account"> По счету</option>
              <option value="installment"> Рассрочка сайт</option>
              <option value="site"> Сайт</option>
              <option value="card">Карта</option>
              <option value="transfer">Перевод</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Доставка</label>
            <select id="deliverySelect" class="form-control">
              <option value="pickup">Самовывоз</option>
              <option value="delivery">Доставка</option>
              <option value="courier">Курьер</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">По акции -10%</label>
            <div class="form-check form-switch mt-2">
              <input class="form-check-input" type="checkbox" id="promoSwitch">
              <label class="form-check-label" for="promoSwitch">Активировать</label>
            </div>
          </div>
          <div class="col-12">
            <label class="form-label">Комментарий</label>
            <textarea id="notesInput" class="form-control" rows="3" placeholder="..."></textarea>
          </div>
        </div>
      </div>

      {% if is_edit %}
      <div id="step-4" class="step d-none">
        <div class="card mb-6">
          <div class="card-header">
            <h5 class="card-title m-0">История изменений</h5>
          </div>
          <div class="card-body mt-3">
            <ul class="timeline pb-0 mb-0">
              <li class="timeline-item timeline-item-transparent border-primary">
                <span class="timeline-point timeline-point-primary"></span>
                <div class="timeline-event">
                  <div class="timeline-header mb-1">
                    <h6 class="mb-0">Создан заказ №{{ order.order_number }}</h6>
                    <small class="text-body-secondary">{{ order.created_at|date:"d.m.Y H:i" }}</small>
                  </div>
                  <p class="mt-1 mb-3">
                    Создал: {{ order.created_by.get_full_name|default:order.created_by.username }}
                  </p>
                </div>
              </li>
              <li class="timeline-item timeline-item-transparent border-primary">
                <span class="timeline-point timeline-point-primary"></span>
                <div class="timeline-event">
                  <div class="timeline-header mb-1">
                    <h6 class="mb-0">Последнее изменение</h6>
                    <small class="text-body-secondary">{{ order.updated_at|date:"d.m.Y H:i" }}</small>
                  </div>
                  <p class="mt-1 mb-2">
                    Изменил: {{ order.updated_by.get_full_name|default:order.updated_by.username }}
                  </p>
                  <div class="row g-2 small text-body-secondary">
                    <div class="col-md-6">Статус: <strong>{{ order.get_status_display }}</strong></div>
                    <div class="col-md-6">Источник: <strong>{{ order.get_source_display|default:order.source }}</strong></div>
                    <div class="col-md-6">Оплата: <strong>{{ order.get_payment_method_display|default:order.payment_method }}</strong></div>
                    <div class="col-md-6">Доставка: <strong>{{ order.get_delivery_method_display|default:order.delivery_method }}</strong></div>
                    <div class="col-md-6">Акция -10%: <strong>{% if order.is_promo %}Да{% else %}Нет{% endif %}</strong></div>
                    {% if order.sale_number %}
                    <div class="col-md-6">Номер реализации: <strong>{{ order.sale_number }}</strong></div>
                    {% endif %}
                  </div>
                </div>
              </li>
            </ul>
          </div>
        </div>
      </div>
      {% endif %}

      <hr class="my-5" />
      <div class="d-flex justify-content-between align-items-center mt-4 pt-3 border-top">
        <button id="prevBtn" class="btn btn-outline-secondary d-flex align-items-center px-4 py-2" disabled>
          <i class="ri-arrow-left-line me-2"></i>
          Назад
        </button>
        <div class="d-flex gap-3">
          {% if is_edit %}
          <button id="saveBtn" class="btn btn-success d-flex align-items-center px-4 py-2">
            <i class="ri-save-line me-2"></i>
            Сохранить изменения
          </button>
          {% else %}
          <button id="saveBtn" class="btn btn-success d-flex align-items-center px-4 py-2">
            <i class="ri-add-line me-2"></i>
            Создать заказ
          </button>
          {% endif %}
          <button id="nextBtn" class="btn btn-primary d-flex align-items-center px-4 py-2">
            Далее
            <i class="ri-arrow-right-line ms-2"></i>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Данные для JS (скрытые) -->
{% if is_edit and order %}
<script type="application/json" id="order-data">
{
  "order": {
    "id": "{{ order.id }}",
    "client_id": "{{ order.client.id }}",
    "status": "{{ order.status }}",
    "source": "{{ order.source }}",
    "payment_method": "{{ order.payment_method }}",
    "delivery_method": "{{ order.delivery_method }}",
    "is_promo": {{ order.is_promo|yesno:"true,false" }},
    "notes": "{{ order.notes|escapejs }}",
    "items": [
      {% for it in order.items.all %}
      {
        "product_id": {{ it.product.id }},
        "name": "{{ it.product_name|escapejs }}",
        "code": "{{ it.product_code|escapejs }}",
        "price": "{{ it.price }}",
        "quantity": {{ it.quantity }},
        "city": "{{ it.branch_city|escapejs }}"
      }{% if not forloop.last %},{% endif %}
      {% endfor %}
    ]
  },
  "client_initial": {% if client_initial %}{
    "phone": "{{ client_initial.phone|escapejs }}",
    "name": "{{ client_initial.name|escapejs }}",
    "city": "{{ client_initial.city|escapejs }}",
    "address": "{{ client_initial.address|escapejs }}",
    "address_comment": "{{ client_initial.address_comment|escapejs }}"
  }{% else %}null{% endif %}
}
</script>
{% endif %}

<!-- Modal для добавления клиента -->
<div class="modal fade" id="addClientModal" tabindex="-1" aria-labelledby="addClientModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addClientModalLabel">Добавить нового клиента</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="addClientForm">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Тип клиента</label>
              <select id="newClientType" class="form-control" required>
                <option value="individual">Физическое лицо</option>
                <option value="legal">Юридическое лицо</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Телефон</label>
              <input id="newClientPhone" type="tel" class="form-control" placeholder="+7 (___) ___-__-__" required />
            </div>
            <div class="col-md-12">
              <label class="form-label">ФИО / Название организации</label>
              <input id="newClientName" type="text" class="form-control" placeholder="Введите ФИО или название организации" required />
            </div>
            <div class="col-md-6">
              <label class="form-label">Город</label>
              <input id="newClientCity" type="text" class="form-control" placeholder="Введите город" />
            </div>
            <div class="col-md-6">
              <label class="form-label">Адрес</label>
              <input id="newClientAddress" type="text" class="form-control" placeholder="Введите адрес" />
            </div>
            <div class="col-12">
              <label class="form-label">Комментарий</label>
              <textarea id="newClientComment" class="form-control" rows="3" placeholder="Дополнительная информация о клиенте"></textarea>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-label-secondary" data-bs-dismiss="modal">Отмена</button>
        <button type="button" class="btn btn-primary" id="saveNewClientBtn">
          <i class="icon-base ri ri-save-line me-1"></i>
          Сохранить клиента
        </button>
      </div>
    </div>
  </div>
</div>

<script src="{% static 'frontend/assets/js/order-form.js' %}"></script>
{% endblock %}
