{% extends 'base.html' %}
{% load static %}

{% block title %}{% if is_edit %}Редактировать заказ{% else %}Создать заказ{% endif %}{% endblock %}

{% block content %}
<div class="container-xxl flex-grow-1 container-p-y">
  <div class="d-flex justify-content-between align-items-center mb-6">
    <h4 class="mb-0">{% if is_edit %}Редактирование заказа{% else %}Создание заказа{% endif %}</h4>
    <a href="{% url 'orders:orders_list' %}" class="btn btn-label-secondary">
      <i class="icon-base ri ri-arrow-left-line me-1"></i>
      Назад к списку
    </a>
  </div>

  <div class="card">
    <div class="card-body">
      <ul class="nav nav-pills nav-fill mb-6 bg-light p-2 rounded" id="stepsNav">
        <li class="nav-item">
          <button class="nav-link active d-flex align-items-center justify-content-center py-3" data-step="1">
            <i class="ri-shopping-cart-line me-2"></i>
            <span>Шаг 1: Товары</span>
          </button>
        </li>
        <li class="nav-item">
          <button class="nav-link d-flex align-items-center justify-content-center py-3" data-step="2">
            <i class="ri-user-line me-2"></i>
            <span>Шаг 2: Клиент</span>
          </button>
        </li>
        <li class="nav-item">
          <button class="nav-link d-flex align-items-center justify-content-center py-3" data-step="3">
            <i class="ri-settings-line me-2"></i>
            <span>Шаг 3: Параметры</span>
          </button>
        </li>
        {% if is_edit %}
        <li class="nav-item">
          <button class="nav-link d-flex align-items-center justify-content-center py-3" data-step="4">
            <i class="ri-history-line me-2"></i>
            <span>История</span>
          </button>
        </li>
        {% endif %}
      </ul>

      <div id="step-1" class="step">
        <div class="row g-4 align-items-end">
          <div class="col-md-3">
            <label class="form-label fw-semibold">
              <i class="ri-barcode-line me-1"></i>
              Код товара
            </label>
            <input id="productCode" type="text" class="form-control" placeholder="Введите код товара" />
          </div>
          <div class="col-md-3">
            <label class="form-label fw-semibold">
              <i class="ri-shopping-bag-line me-1"></i>
              Товар
            </label>
            <input id="productSelect" type="text" class="form-control" placeholder="Начните вводить код или название товара" autocomplete="off" />
            <!-- Скрытый select для хранения данных о товарах -->
            <select id="productSelectHidden" style="display: none;">
              <option value="">— Выберите товар —</option>
            </select>
            <!-- Результаты поиска -->
            <div id="productSearchResults" class="dropdown-menu w-100" style="display: none; max-height: 300px; overflow-y: auto;"></div>
          </div>
          <div class="col-md-2">
            <label class="form-label fw-semibold">
              <i class="ri-money-dollar-circle-line me-1"></i>
              Цена
            </label>
            <input id="productPrice" type="number" class="form-control form-control-sm" step="0.01" placeholder="0.00" />
          </div>
          <div class="col-md-2">
            <label class="form-label fw-semibold">
              <i class="ri-number-1 me-1"></i>
              Кол-во
            </label>
            <input id="productQty" type="number" class="form-control form-control-sm" value="1" min="1" />
          </div>
          <div class="col-md-2">
            <label class="form-label fw-semibold">
              <i class="ri-price-tag-3-line me-1"></i>
              Уровень цен
            </label>
            <select id="priceLevelSelect" class="form-control form-control-sm">
              <option value="retail">Розничная</option>
              <option value="promotional">Акционная</option>
              <option value="wholesale">Оптовая</option>
            </select>
          </div>
        </div>

        <div class="row g-4 mt-2">
          <div class="col-md-3">
            <label class="form-label fw-semibold">
              <i class="ri-map-pin-line me-1"></i>
              Город
            </label>
            <select id="productCitySelect" class="form-control">
              <option value="">— Выберите город —</option>
              <option value="Актобе">Актобе</option>
              <option value="Алматы">Алматы</option>
              <option value="Астана">Астана</option>
              <option value="Караганда">Караганда</option>
              <option value="Павлодар">Павлодар</option>
              <option value="Петропавловск">Петропавловск</option>
              <option value="Семей">Семей</option>
              <option value="Усть-Каменогорск">Усть-Каменогорск</option>
              <option value="Шымкент">Шымкент</option>
              <option value="Уральск">Уральск</option>
              <option value="Кызылорда">Кызылорда</option>
              <option value="Центральный Склад">Центральный Склад</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label fw-semibold">
              <i class="ri-building-line me-1"></i>
              Филиал
            </label>
            <input id="productBranch" type="text" class="form-control" readonly />
          </div>
          <div class="col-md-3">
            <label class="form-label fw-semibold">
              <i class="ri-truck-line me-1"></i>
              Тип шины
            </label>
            <input id="productTireType" type="text" class="form-control" readonly disabled />
          </div>
          <div class="col-md-3">
            <label class="form-label fw-semibold">
              <i class="ri-folder-line me-1"></i>
              Ассортиментная группа
            </label>
            <input id="productAssortmentGroup" type="text" class="form-control" readonly disabled />
          </div>
        </div>

        <div class="row g-4 mt-3">
          <div class="col-md-2">
            <button id="addItemBtn" class="btn btn-primary w-100 d-flex align-items-center justify-content-center py-3">
              <i class="ri-add-line me-2"></i>
              <span>Добавить товар</span>
            </button>
          </div>
        </div>
        <hr class="my-5" />

        <div class="table-responsive border rounded">
          <table class="table table-hover mb-0" id="itemsTable">
            <thead class="table-light">
              <tr>
                <th class="border-0">Код</th>
                <th class="border-0">Номенклатура</th>
                <th class="border-0">Город</th>
                <th class="text-end border-0">Цена</th>
                <th class="text-center border-0">Кол-во</th>
                <th class="text-end border-0">Сумма</th>
                <th class="text-center border-0" width="80">Действия</th>
              </tr>
            </thead>
            <tbody></tbody>
            <tfoot class="table-light">
              <tr>
                <td colspan="5" class="text-end border-0"><strong>Итого:</strong></td>
                <td class="text-end" id="totalCell"><strong>₸0</strong></td>
                <td></td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>

      <div id="step-2" class="step d-none">
        <div class="row g-4">
          <div class="col-md-4">
            <label class="form-label fw-semibold">
              <i class="ri-phone-line me-1"></i>
              Телефон
            </label>
            <input id="clientPhoneInput" type="tel" class="form-control" placeholder="+7 (___) ___-__-__" />
          </div>

          <div class="col-md-6">
            <label class="form-label fw-semibold">
              <i class="ri-user-line me-1"></i>
              Клиент
            </label>
            <select id="clientSelect" class="form-control">
              <option value="">— Выберите клиента —</option>
              {% for c in clients %}
              <option value="{{ c.id }}">{{ c.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label">&nbsp;</label>
            <button type="button" class="btn btn-outline-primary w-100 d-flex align-items-center justify-content-center py-2" data-bs-toggle="modal" data-bs-target="#addClientModal">
              <i class="ri-add-line me-2"></i>
              <span>Новый</span>
            </button>
          </div>

          <div class="col-md-6">
            <label class="form-label">ФИО / Название</label>
            <input id="clientNameInput" type="text" class="form-control" placeholder="Введите ФИО или название" />
          </div>
          <div class="col-md-6">
            <label class="form-label">Город</label>
            <input id="clientCityInput" type="text" class="form-control" placeholder="Введите город" />
          </div>

          <div class="col-12">
            <label class="form-label">Адрес / Комментарий</label>
            <textarea id="clientAddressComment" class="form-control" rows="3" placeholder="Адрес и дополнительные комментарии"></textarea>
          </div>
        </div>
      </div>

      <div id="step-3" class="step d-none">
        <div class="row g-4">
          <div class="col-md-4">
            <label class="form-label">Статус</label>
            <select id="statusSelect" class="form-control">
              <optgroup label="НОВЫЕ">
                <option value="new">Новый</option>
                <option value="new_paid">Новый оплаченный</option>
              </optgroup>
            
              <optgroup label="ПРОМЕЖУТОЧНЫЕ">
                <option value="reserve">Резерв</option>
                <option value="transfer">Перемещение</option>
                <option value="delivery">Доставка</option>
                <option value="callback">Перезвонить</option>
              </optgroup>
            
              <optgroup label="ЗАВЕРШЕННЫЕ">
                <option value="completed">Выполнен</option>
                <option value="refund">Возврат средств</option>
                <option value="cancelled">Отменён (указать причину)</option>
              </optgroup>
            
              <optgroup label="ОТМЕНА — ПРИЧИНЫ">
                <option value="cancel_no_answer">Отменен — не дозвонился</option>
                <option value="cancel_not_suitable_year">Отменен — не устроил год</option>
                <option value="cancel_wrong_order">Отменен — ошибочный заказ</option>
                <option value="cancel_found_other">Отменен — нашел другие</option>
                <option value="cancel_delivery_terms">Отменен — условия доставки</option>
                <option value="cancel_no_quantity">Отменен — нет нужного кол-ва</option>
                <option value="cancel_incomplete">Отменен — не комплект</option>
              </optgroup>
            </select>
            
          </div>
          <div class="col-md-4">
            <label class="form-label">Откуда заказ</label>
            <select id="sourceSelect" class="form-control">
              <option value="callcentr">2710</option>
              <option value="2gis">2GIS WhatsApp</option>
              <option value="email">E-mail</option>
              <option value="instagram">Instagram</option>
              <option value="kaspi">Kaspi</option>
              <option value="whatsapp">Whatsapp</option>  
              <option value="website">Сайт</option>   
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Способ оплаты</label>
            <select id="paymentSelect" class="form-control">
              <option value="airba">Airba pay</option>
              <option value="halyk">Halyk</option>
              <option value="kaspi">Kaspi</option>
              <option value="woopay">Wooppay</option>
              <option value="bcc"> БЦК</option>
              <option value="cassa"> На кассе</option>
              <option value="account"> По счету</option>
              <option value="installment"> Рассрочка сайт</option>
              <option value="site"> Сайт</option>
              <option value="card">Карта</option>
              <option value="transfer">Перевод</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Доставка</label>
            <select id="deliverySelect" class="form-control">
              <option value="pickup">Самовывоз</option>
              <option value="delivery">Доставка</option>
              <option value="courier">Курьер</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">По акции -10%</label>
            <div class="form-check form-switch mt-2">
              <input class="form-check-input" type="checkbox" id="promoSwitch">
              <label class="form-check-label" for="promoSwitch">Активировать</label>
            </div>
          </div>
          <div class="col-12">
            <label class="form-label">Комментарий</label>
            <textarea id="notesInput" class="form-control" rows="3" placeholder="..."></textarea>
          </div>
        </div>
      </div>

      {% if is_edit %}
      <div id="step-4" class="step d-none">
        <div class="card mb-6">
          <div class="card-header">
            <h5 class="card-title m-0">История изменений</h5>
          </div>
          <div class="card-body mt-3">
            <ul class="timeline pb-0 mb-0">
              <li class="timeline-item timeline-item-transparent border-primary">
                <span class="timeline-point timeline-point-primary"></span>
                <div class="timeline-event">
                  <div class="timeline-header mb-1">
                    <h6 class="mb-0">Создан заказ №{{ order.order_number }}</h6>
                    <small class="text-body-secondary">{{ order.created_at|date:"d.m.Y H:i" }}</small>
                  </div>
                  <p class="mt-1 mb-3">
                    Создал: {{ order.created_by.get_full_name|default:order.created_by.username }}
                  </p>
                </div>
              </li>
              <li class="timeline-item timeline-item-transparent border-primary">
                <span class="timeline-point timeline-point-primary"></span>
                <div class="timeline-event">
                  <div class="timeline-header mb-1">
                    <h6 class="mb-0">Последнее изменение</h6>
                    <small class="text-body-secondary">{{ order.updated_at|date:"d.m.Y H:i" }}</small>
                  </div>
                  <p class="mt-1 mb-2">
                    Изменил: {{ order.updated_by.get_full_name|default:order.updated_by.username }}
                  </p>
                  <div class="row g-2 small text-body-secondary">
                    <div class="col-md-6">Статус: <strong>{{ order.get_status_display }}</strong></div>
                    <div class="col-md-6">Источник: <strong>{{ order.get_source_display|default:order.source }}</strong></div>
                    <div class="col-md-6">Оплата: <strong>{{ order.get_payment_method_display|default:order.payment_method }}</strong></div>
                    <div class="col-md-6">Доставка: <strong>{{ order.get_delivery_method_display|default:order.delivery_method }}</strong></div>
                    <div class="col-md-6">Акция -10%: <strong>{% if order.is_promo %}Да{% else %}Нет{% endif %}</strong></div>
                    {% if order.sale_number %}
                    <div class="col-md-6">Номер реализации: <strong>{{ order.sale_number }}</strong></div>
                    {% endif %}
                  </div>
                </div>
              </li>
            </ul>
          </div>
        </div>
      </div>
      {% endif %}

      <hr class="my-5" />
      <div class="d-flex justify-content-between align-items-center mt-4 pt-3 border-top">
        <button id="prevBtn" class="btn btn-outline-secondary d-flex align-items-center px-4 py-2" disabled>
          <i class="ri-arrow-left-line me-2"></i>
          Назад
        </button>
        <div class="d-flex gap-3">
          {% if is_edit %}
          <button id="saveBtn" class="btn btn-success d-flex align-items-center px-4 py-2">
            <i class="ri-save-line me-2"></i>
            Сохранить изменения
          </button>
          {% else %}
          <button id="saveBtn" class="btn btn-success d-flex align-items-center px-4 py-2">
            <i class="ri-add-line me-2"></i>
            Создать заказ
          </button>
          {% endif %}
          <button id="nextBtn" class="btn btn-primary d-flex align-items-center px-4 py-2">
            Далее
            <i class="ri-arrow-right-line ms-2"></i>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal для добавления клиента -->
<div class="modal fade" id="addClientModal" tabindex="-1" aria-labelledby="addClientModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addClientModalLabel">Добавить нового клиента</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="addClientForm">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Тип клиента</label>
              <select id="newClientType" class="form-control" required>
                <option value="individual">Физическое лицо</option>
                <option value="legal">Юридическое лицо</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Телефон</label>
              <input id="newClientPhone" type="tel" class="form-control" placeholder="+7 (___) ___-__-__" required />
            </div>
            <div class="col-md-12">
              <label class="form-label">ФИО / Название организации</label>
              <input id="newClientName" type="text" class="form-control" placeholder="Введите ФИО или название организации" required />
            </div>
            <div class="col-md-6">
              <label class="form-label">Город</label>
              <input id="newClientCity" type="text" class="form-control" placeholder="Введите город" />
            </div>
            <div class="col-md-6">
              <label class="form-label">Адрес</label>
              <input id="newClientAddress" type="text" class="form-control" placeholder="Введите адрес" />
            </div>
            <div class="col-12">
              <label class="form-label">Комментарий</label>
              <textarea id="newClientComment" class="form-control" rows="3" placeholder="Дополнительная информация о клиенте"></textarea>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-label-secondary" data-bs-dismiss="modal">Отмена</button>
        <button type="button" class="btn btn-primary" id="saveNewClientBtn">
          <i class="icon-base ri ri-save-line me-1"></i>
          Сохранить клиента
        </button>
      </div>
    </div>
  </div>
</div>

<script>
(function() {
  const steps = {% if is_edit %}[1,2,3,4]{% else %}[1,2,3]{% endif %};
  let current = 1;
  const items = [];

  const productSelect = document.getElementById('productSelect');
  const productSelectHidden = document.getElementById('productSelectHidden');
  const productCodeInput = document.getElementById('productCode');
  const priceInput = document.getElementById('productPrice');
  const qtyInput = document.getElementById('productQty');
  const priceLevelSelect = document.getElementById('priceLevelSelect');
  const addItemBtn = document.getElementById('addItemBtn');
  const itemsTableBody = document.querySelector('#itemsTable tbody');
  const totalCell = document.getElementById('totalCell');
  const productSearchResults = document.getElementById('productSearchResults');
  
  let selectedProduct = null;  // Храним выбранный товар

  // Debounce helper для поиска товаров
  function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  }

  // Поиск товаров через AJAX
  const searchProducts = debounce(async (query) => {
    if (!query || query.length < 2) {
      productSearchResults.style.display = 'none';
      return;
    }

    try {
      const response = await fetch(`{% url 'orders:product_search' %}?q=${encodeURIComponent(query)}`);
      const data = await response.json();
      
      if (data.products && data.products.length > 0) {
        productSearchResults.innerHTML = data.products.map(product => `
          <div class="dropdown-item" style="cursor: pointer;" data-product='${JSON.stringify(product)}'>
            <div class="d-flex justify-content-between">
              <div>
                <strong>${product.name}</strong><br>
                <small class="text-muted">Код: ${product.code || '—'}</small>
              </div>
              <div class="text-end">
                <div>₸${product.price.toLocaleString()}</div>
                ${product.wholesale_price ? `<small class="text-muted">Опт: ₸${product.wholesale_price.toLocaleString()}</small>` : ''}
              </div>
            </div>
          </div>
        `).join('');
        productSearchResults.style.display = 'block';
      } else {
        productSearchResults.innerHTML = '<div class="dropdown-item text-muted">Товары не найдены</div>';
        productSearchResults.style.display = 'block';
      }
    } catch (error) {
      console.error('Ошибка поиска товаров:', error);
      productSearchResults.style.display = 'none';
    }
  }, 300);

  // Обработчик ввода в поле поиска товаров
  productSelect.addEventListener('input', (e) => {
    const query = e.target.value.trim();
    if (query) {
      searchProducts(query);
    } else {
      productSearchResults.style.display = 'none';
      selectedProduct = null;
      // Очищаем только поля товара, но не код
      if (productBranch) productBranch.value = '';
      if (productTireType) productTireType.value = '';
      if (productAssortmentGroup) productAssortmentGroup.value = '';
      if (priceInput) priceInput.value = '';
    }
  });

  // Поиск товара по коду с debounce
  const searchProductByCode = debounce(async (code) => {
    if (!code) {
      clearProductFields();
      selectedProduct = null;
      return;
    }

    // Поиск товара по коду
    try {
      const response = await fetch(`{% url 'orders:product_search' %}?q=${encodeURIComponent(code)}`);
      const data = await response.json();
      
      if (data.products && data.products.length > 0) {
        // Ищем точное совпадение по коду
        const exactMatch = data.products.find(product => 
          product.code && product.code.toLowerCase() === code.toLowerCase()
        );
        
        if (exactMatch) {
          selectedProduct = exactMatch;
          productSelect.value = exactMatch.name;
          updateProductFields(exactMatch);
          productSearchResults.style.display = 'none';
          console.log('Товар найден и выбран:', exactMatch);
        } else {
          // Если точного совпадения нет, показываем результаты поиска
          productSearchResults.innerHTML = data.products.map(product => `
            <div class="dropdown-item" style="cursor: pointer;" data-product='${JSON.stringify(product)}'>
              <div class="d-flex justify-content-between">
                <div>
                  <strong>${product.name}</strong><br>
                  <small class="text-muted">Код: ${product.code || '—'}</small>
                </div>
                <div class="text-end">
                  <div>₸${product.price.toLocaleString()}</div>
                  ${product.wholesale_price ? `<small class="text-muted">Опт: ₸${product.wholesale_price.toLocaleString()}</small>` : ''}
                </div>
              </div>
            </div>
          `).join('');
          productSearchResults.style.display = 'block';
        }
      } else {
        // Если товары не найдены, очищаем поля товара
        clearProductFields();
        selectedProduct = null;
        productSearchResults.innerHTML = '<div class="dropdown-item text-muted">Товары не найдены</div>';
        productSearchResults.style.display = 'block';
      }
    } catch (error) {
      console.error('Ошибка поиска товаров по коду:', error);
      productSearchResults.style.display = 'none';
      // При ошибке очищаем поля товара
      clearProductFields();
      selectedProduct = null;
    }
  }, 300);

  // Обработчик ввода в поле кода товара
  productCodeInput.addEventListener('input', (e) => {
    const code = e.target.value.trim();
    searchProductByCode(code);
  });

  // Обработчик клика по результату поиска
  productSearchResults.addEventListener('click', (e) => {
    const item = e.target.closest('[data-product]');
    if (item) {
      selectedProduct = JSON.parse(item.getAttribute('data-product'));
      productSelect.value = selectedProduct.name;
      productCodeInput.value = selectedProduct.code || '';
      updateProductFields(selectedProduct);
      productSearchResults.style.display = 'none';
    }
  });

  // Скрытие результатов при клике вне поля
  document.addEventListener('click', (e) => {
    if (!productSelect.contains(e.target) && !productSearchResults.contains(e.target)) {
      productSearchResults.style.display = 'none';
    }
  });

  // Функция обновления полей товара
  function updateProductFields(product) {
    if (!product) return;
    
    // Заполняем поля товара
    if (productBranch) productBranch.value = product.branch_city || '';
    if (productTireType) productTireType.value = product.tire_type || '';
    if (productAssortmentGroup) productAssortmentGroup.value = product.assortment_group || '';
    
    // Обновляем цену в зависимости от выбранного уровня цен
    updatePriceByProduct(product);
    
    console.log('Поля товара обновлены:', {
      name: product.name,
      code: product.code,
      branch_city: product.branch_city,
      tire_type: product.tire_type,
      assortment_group: product.assortment_group,
      price: product.price
    });
  }

  // Функция очистки полей товара (кроме кода)
  function clearProductFields() {
    if (productBranch) productBranch.value = '';
    if (productTireType) productTireType.value = '';
    if (productAssortmentGroup) productAssortmentGroup.value = '';
    if (priceInput) priceInput.value = '';
    if (productSelect) productSelect.value = '';
    productSearchResults.style.display = 'none';
  }

  // Функция полной очистки всех полей
  function clearAllFields() {
    clearProductFields();
    if (productCodeInput) productCodeInput.value = '';
    selectedProduct = null;
  }

  // Обновление цены по выбранному товару
  function updatePriceByProduct(product) {
    if (!product || !priceInput) return;
    
    const priceLevel = priceLevelSelect ? priceLevelSelect.value : 'retail';
    let price = product.price; // Базовая цена по умолчанию
    
    // Проверяем наличие специальных цен и используем их если они есть
    if (priceLevel === 'wholesale' && product.wholesale_price) {
      price = product.wholesale_price;
    } else if (priceLevel === 'promotional' && product.promotional_price) {
      price = product.promotional_price;
    } else if (priceLevel === 'retail' && product.retail_price) {
      price = product.retail_price;
    }
    
    priceInput.value = price.toFixed(2);
    console.log(`Цена обновлена: уровень=${priceLevel}, цена=${price}, товар=${product.name}`);
  }

  const clientSelect = document.getElementById('clientSelect');
  const clientPhoneInput = document.getElementById('clientPhoneInput');
  const clientNameInput = document.getElementById('clientNameInput');
  const clientCityInput = document.getElementById('clientCityInput');
  const clientAddressComment = document.getElementById('clientAddressComment');
  const statusSelect = document.getElementById('statusSelect');
  const sourceSelect = document.getElementById('sourceSelect');
  const paymentSelect = document.getElementById('paymentSelect');
  const deliverySelect = document.getElementById('deliverySelect');
  const promoSwitch = document.getElementById('promoSwitch');
  const notesInput = document.getElementById('notesInput');

  // Доп. поля, связанные с товаром
  const productCitySelect = document.getElementById('productCitySelect');
  const productBranch = document.getElementById('productBranch');
  const productTireType = document.getElementById('productTireType');
  const productAssortmentGroup = document.getElementById('productAssortmentGroup');

  function switchStep(step) {
    steps.forEach(s => {
      document.getElementById(`step-${s}`).classList.toggle('d-none', s !== step);
      const btn = document.querySelector(`#stepsNav [data-step="${s}"]`);
      btn.classList.toggle('active', s === step);
    });
    current = step;
    document.getElementById('prevBtn').disabled = (current === 1);
  }

  document.getElementById('prevBtn').addEventListener('click', () => {
    if (current > 1) switchStep(current - 1);
  });
  document.getElementById('nextBtn').addEventListener('click', () => {
    const last = steps[steps.length - 1];
    // Валидация перед переходом
    if (current === 1 && items.length === 0) {
      alert('Добавьте хотя бы один товар');
      return;
    }
    if (current === 2 && !clientSelect.value) {
      alert('Выберите клиента или введите телефон для автоподбора');
      return;
    }
    if (current < last) switchStep(current + 1);
  });
  document.querySelectorAll('#stepsNav [data-step]').forEach(el => {
    el.addEventListener('click', () => switchStep(parseInt(el.dataset.step)));
  });


  // Обновление цены при изменении уровня цен
  priceLevelSelect?.addEventListener('change', () => {
    console.log('Уровень цен изменен на:', priceLevelSelect.value);
    console.log('Выбранный товар:', selectedProduct);
    
    if (selectedProduct) {
      updatePriceByProduct(selectedProduct);
    } else {
      console.log('Товар не выбран, цена не обновлена');
    }
  });



  // Предзаполнение полей по выбранному клиенту
  clientSelect?.addEventListener('change', async () => {
    const id = clientSelect.value;
    if (!id) return;
    try {
      const res = await fetch('{% url "orders:client_lookup" %}?id=' + encodeURIComponent(id), { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
      if (!res.ok) return;
      const data = await res.json();
      if (data.status === 'success') {
        if (clientNameInput) clientNameInput.value = data.name || '';
        if (clientCityInput) clientCityInput.value = data.city || '';
        if (clientPhoneInput) clientPhoneInput.value = data.phone || '';
        if (clientAddressComment) clientAddressComment.value = [data.address, data.address_comment].filter(Boolean).join(' | ');
      }
    } catch (_) {}
  });

  // Debounce helper для поиска клиентов
  function debounce(fn, ms) {
    let t; return function(...args){ clearTimeout(t); t = setTimeout(() => fn.apply(this, args), ms); };
  }

  // Поиск по номеру телефона
  const onPhoneInput = debounce(async () => {
    const raw = clientPhoneInput ? clientPhoneInput.value : '';
    if (!raw) return;
    try {
      const res = await fetch('{% url "orders:client_lookup" %}?phone=' + encodeURIComponent(raw), { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
      if (!res.ok) return;
      const data = await res.json();
      if (data.status === 'success') {
        if (clientNameInput) clientNameInput.value = data.name || '';
        if (clientCityInput) clientCityInput.value = data.city || '';
        if (clientPhoneInput) clientPhoneInput.value = data.phone || '';
        if (clientAddressComment) clientAddressComment.value = [data.address, data.address_comment].filter(Boolean).join(' | ');
        const opt = document.querySelector(`#clientSelect option[value='${data.id}']`);
        if (opt) opt.selected = true;
      }
    } catch (_) {}
  }, 400);

  clientPhoneInput?.addEventListener('input', onPhoneInput);

  // Предзаполнение ФИО/названия по выбранному клиенту
  clientSelect?.addEventListener('change', () => {
    const opt = clientSelect.options[clientSelect.selectedIndex];
    const name = opt ? (opt.textContent || '').trim() : '';
    if (clientNameInput && name && !clientNameInput.value) {
      clientNameInput.value = name;
    }
  });

  function formatInt(num) {
    try {
      const n = Math.round(parseFloat(num || 0));
      return n.toLocaleString('ru-RU');
    } catch (_) { return num; }
  }

  function formatMoney(num) {
    try {
      const n = Math.round(parseFloat(num || 0));
      return n.toLocaleString('ru-RU');
    } catch (_) { return num; }
  }

  function renderItems() {
    itemsTableBody.innerHTML = '';
    let total = 0;
    items.forEach((it, idx) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${it.code || '—'}</td>
        <td>${it.name}</td>
        <td>${it.city || '—'}</td>
        <td class="text-end num">₸${formatMoney(it.price)}</td>
        <td class="text-center num">${formatInt(it.quantity)}</td>
        <td class="text-end num">₸${formatMoney(it.price * it.quantity)}</td>
        <td class="text-end">
          <button class="btn btn-sm btn-outline-danger" data-remove="${idx}" title="Удалить">
            <i class="ri-delete-bin-line"></i>
          </button>
        </td>
      `;
      itemsTableBody.appendChild(tr);
      total += it.price * it.quantity;
    });
    totalCell.innerHTML = `<strong class="num">₸${formatMoney(total)}</strong>`;
  }

  itemsTableBody.addEventListener('click', (e) => {
    const btn = e.target.closest('[data-remove]');
    if (!btn) return;
    const idx = parseInt(btn.getAttribute('data-remove'));
    items.splice(idx, 1);
    renderItems();
  });

  addItemBtn.addEventListener('click', (e) => {
    e.preventDefault();
    
    if (!selectedProduct) {
      alert('Сначала выберите товар из списка');
      return;
    }
    
    // Проверяем, что выбран город
    const selectedCity = productCitySelect ? productCitySelect.value : '';
    if (!selectedCity) {
      alert('Выберите город');
      return;
    }
    
    const manualCode = (productCodeInput ? productCodeInput.value : '').trim();
    const code = manualCode || selectedProduct.code || '';
    
    // Получаем цену из поля или используем цену товара
    let price = parseFloat(priceInput && priceInput.value ? priceInput.value : 'NaN');
    if (!isFinite(price)) {
      price = selectedProduct.price;
    }
    
    const quantity = Math.max(1, parseInt(qtyInput.value || '1'));
    
    items.push({ 
      product_id: selectedProduct.id, 
      name: selectedProduct.name, 
      code, 
      price, 
      quantity, 
      city: selectedCity 
    });
    
    renderItems();
    
    // Очищаем поля после добавления
    clearAllFields();
  });

  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
  }

  async function submitOrder() {
    if (!items.length) {
      alert('Добавьте хотя бы один товар');
      switchStep(1);
      return;
    }
    if (!clientSelect.value) {
      alert('Выберите клиента');
      switchStep(2);
      return;
    }

    const payload = {
      client_id: clientSelect.value,
      status: statusSelect.value,
      source: sourceSelect.value,
      payment_method: paymentSelect.value,
      delivery_method: deliverySelect.value,
      price_level: priceLevelSelect.value,
      is_promo: promoSwitch.checked,
      sale_number: '',
      notes: notesInput.value || '',
      client_phone: clientPhoneInput ? clientPhoneInput.value : '',
      client_name: clientNameInput ? clientNameInput.value : '',
      client_city: clientCityInput ? clientCityInput.value : '',
      client_address_comment: clientAddressComment ? clientAddressComment.value : '',
      items: items.map(it => ({ product_id: it.product_id, quantity: it.quantity, city: it.city }))
    };

    const isEdit = {% if is_edit %}true{% else %}false{% endif %};
    {% if is_edit and order %}
    const postUrl = '{% url "orders:edit_order" order.id %}';
    {% else %}
    const postUrl = '{% url "orders:add_order" %}';
    {% endif %}

    const res = await fetch(postUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken'),
        'X-Requested-With': 'XMLHttpRequest'
      },
      body: JSON.stringify(payload)
    });

    const data = await res.json().catch(() => ({}));
    if (res.ok && data.status === 'success') {
      // Всегда уходим на список заказов после сохранения
      window.location.href = '{% url "orders:orders_list" %}';
    } else {
      alert(data.message || 'Ошибка сохранения');
    }
  }

  document.getElementById('saveBtn').addEventListener('click', (e) => {
    e.preventDefault();
    submitOrder();
  });

  // Обработка добавления нового клиента
  document.getElementById('saveNewClientBtn').addEventListener('click', async (e) => {
    e.preventDefault();
    
    const form = document.getElementById('addClientForm');
    const formData = new FormData(form);
    
    const clientData = {
      client_type: document.getElementById('newClientType').value,
      phone: document.getElementById('newClientPhone').value,
      name: document.getElementById('newClientName').value,
      city: document.getElementById('newClientCity').value,
      address: document.getElementById('newClientAddress').value,
      address_comment: document.getElementById('newClientComment').value
    };

    try {
      const res = await fetch('{% url "clients:add_client" %}', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken'),
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify(clientData)
      });

      const data = await res.json();
      
      if (res.ok && data.status === 'success') {
        // Добавляем нового клиента в select
        const clientSelect = document.getElementById('clientSelect');
        const newOption = document.createElement('option');
        newOption.value = data.client_id;
        newOption.textContent = clientData.name;
        clientSelect.appendChild(newOption);
        
        // Выбираем нового клиента
        clientSelect.value = data.client_id;
        
        // Заполняем поля формы данными нового клиента
        if (clientPhoneInput) clientPhoneInput.value = clientData.phone;
        if (clientNameInput) clientNameInput.value = clientData.name;
        if (clientCityInput) clientCityInput.value = clientData.city;
        if (clientAddressComment) clientAddressComment.value = [clientData.address, clientData.address_comment].filter(Boolean).join(' | ');
        
        // Закрываем модальное окно
        const modal = bootstrap.Modal.getInstance(document.getElementById('addClientModal'));
        modal.hide();
        
        // Очищаем форму
        form.reset();
        
        // Показываем уведомление об успехе
        if (window.showNotification) {
          window.showNotification('Клиент успешно добавлен!', 'success');
        }
      } else {
        alert(data.message || 'Ошибка при добавлении клиента');
      }
    } catch (error) {
      console.error('Error adding client:', error);
      alert('Ошибка при добавлении клиента');
    }
  });

  // Init from existing order (edit)
  {% if is_edit and order %}
  try {
    // client
    const clientOption = document.querySelector(`#clientSelect option[value='{{ order.client.id }}']`);
    if (clientOption) clientOption.selected = true;

    // status & params
    document.getElementById('statusSelect').value = '{{ order.status }}';
    document.getElementById('sourceSelect').value = '{{ order.source }}';
    document.getElementById('paymentSelect').value = '{{ order.payment_method }}';
    document.getElementById('deliverySelect').value = '{{ order.delivery_method }}';
    document.getElementById('promoSwitch').checked = {{ order.is_promo|yesno:'true,false' }};
    document.getElementById('notesInput').value = `{{ order.notes|escapejs }}`;

    // items
    {% for it in order.items.all %}
      items.push({
        product_id: {{ it.product.id }},
        name: `{{ it.product_name|escapejs }}`,
        code: `{{ it.product_code|escapejs }}`,
        price: parseFloat(`{{ it.price }}`),
        quantity: {{ it.quantity }},
        city: `{{ it.branch_city|escapejs }}`
      });
    {% endfor %}
    renderItems();

    // step 2 fields
    {% if client_initial %}
      if (clientPhoneInput) clientPhoneInput.value = `{{ client_initial.phone|escapejs }}`;
      if (clientNameInput) clientNameInput.value = `{{ client_initial.name|escapejs }}`;
      if (clientCityInput) clientCityInput.value = `{{ client_initial.city|escapejs }}`;
      if (clientAddressComment) clientAddressComment.value = `{{ client_initial.address|escapejs }}{% if client_initial.address_comment %} | {{ client_initial.address_comment|escapejs }}{% endif %}`;
    {% endif %}
  } catch (e) {}
  {% endif %}
})();
</script>
{% endblock %}
