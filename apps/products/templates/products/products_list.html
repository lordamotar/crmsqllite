{% extends 'base.html' %}

{% block title %}Товары{% endblock %}

{% block content %}
  <div class="card">
    <div class="card-datatable">
      <div id="DataTables_Table_0_wrapper" class="dt-container dt-bootstrap5 dt-empty-footer">
        <div class="row mx-2">
          <div class="d-md-flex justify-content-between align-items-center dt-layout-end col-md-auto ms-auto justify-content-md-between justify-content-center d-flex">
            <div class="dt-search me-4">
              <input type="search" class="form-control form-control-sm" id="dt-search-0" placeholder="Поиск товара">
              <label for="dt-search-0"></label>
            </div>
            <div class="dt-buttons btn-group flex-wrap mb-0 w-auto">
              <button type="button" class="btn btn-outline-primary" id="updateProductsBtn">
                <span>
                  <i class="icon-base ri ri-refresh-line icon-sm me-0 me-sm-1"></i>
                  <span class="d-none d-sm-inline-block">Обновить</span>
                </span>
              </button>
              <!--<a href="{% url 'products:add_product' %}" class="btn add-new btn-primary">
                 <span>
                  <i class="icon-base ri ri-add-line icon-sm me-0 me-sm-1"></i>
                  <span class="d-none d-sm-inline-block">Добавить товар</span>
                </span> 
               </a> -->
            </div>
          </div>
        </div>

        <div class="justify-content-between dt-layout-table">
          <div class="d-md-flex justify-content-between align-items-center dt-layout-full table-responsive">
            <table class="datatables-permissions table dataTable dtr-column" id="DataTables_Table_0" style="width: 100%;">
              <thead>
                <tr>
                  <th class="dtr-hidden" style="display:none;"></th>
                  <th>
                    <a href="?sort=code&order={% if current_sort == 'code' and current_order == 'asc' %}desc{% else %}asc{% endif %}" 
                       class="text-decoration-none text-body">
                      Код
                      {% if current_sort == 'code' %}
                        {% if current_order == 'asc' %}
                          <i class="icon-base ri ri-arrow-up-line ms-1"></i>
                        {% else %}
                          <i class="icon-base ri ri-arrow-down-line ms-1"></i>
                        {% endif %}
                      {% endif %}
                    </a>
                  </th>
                  <th>
                    <a href="?sort=name&order={% if current_sort == 'name' and current_order == 'asc' %}desc{% else %}asc{% endif %}" 
                       class="text-decoration-none text-body">
                      Название
                      {% if current_sort == 'name' %}
                        {% if current_order == 'asc' %}
                          <i class="icon-base ri ri-arrow-up-line ms-1"></i>
                        {% else %}
                          <i class="icon-base ri ri-arrow-down-line ms-1"></i>
                        {% endif %}
                      {% endif %}
                    </a>
                  </th>
                  <th>
                    <a href="?sort=price&order={% if current_sort == 'price' and current_order == 'asc' %}desc{% else %}asc{% endif %}" 
                       class="text-decoration-none text-body">
                      Цена
                      {% if current_sort == 'price' %}
                        {% if current_order == 'asc' %}
                          <i class="icon-base ri ri-arrow-up-line ms-1"></i>
                        {% else %}
                          <i class="icon-base ri ri-arrow-down-line ms-1"></i>
                        {% endif %}
                      {% endif %}
                    </a>
                  </th>
                  <th>
                    <a href="?sort=assortment_group&order={% if current_sort == 'assortment_group' and current_order == 'asc' %}desc{% else %}asc{% endif %}" 
                       class="text-decoration-none text-body">
                      Ассортиментная группа
                      {% if current_sort == 'assortment_group' %}
                        {% if current_order == 'asc' %}
                          <i class="icon-base ri ri-arrow-up-line ms-1"></i>
                        {% else %}
                          <i class="icon-base ri ri-arrow-down-line ms-1"></i>
                        {% endif %}
                      {% endif %}
                    </a>
                  </th>
                  <th>
                    <a href="?sort=branch_city&order={% if current_sort == 'branch_city' and current_order == 'asc' %}desc{% else %}asc{% endif %}" 
                       class="text-decoration-none text-body">
                      Город филиала
                      {% if current_sort == 'branch_city' %}
                        {% if current_order == 'asc' %}
                          <i class="icon-base ri ri-arrow-up-line ms-1"></i>
                        {% else %}
                          <i class="icon-base ri ri-arrow-down-line ms-1"></i>
                        {% endif %}
                      {% endif %}
                    </a>
                  </th>
                  <th>
                    <a href="?sort=created_at&order={% if current_sort == 'created_at' and current_order == 'asc' %}desc{% else %}asc{% endif %}" 
                       class="text-decoration-none text-body">
                      Создан
                      {% if current_sort == 'created_at' %}
                        {% if current_order == 'asc' %}
                          <i class="icon-base ri ri-arrow-up-line ms-1"></i>
                        {% else %}
                          <i class="icon-base ri ri-arrow-down-line ms-1"></i>
                        {% endif %}
                      {% endif %}
                    </a>
                  </th>
                  <th>Действия</th>
                </tr>
              </thead>
              <tbody>
                {% for product in products %}
                <tr>
                  <td class="dtr-hidden" style="display:none;"></td>
                  <td><span class="text-nowrap text-heading">{{ product.code|default:"—" }}</span></td>
                  <td><span class="text-nowrap">{{ product.name }}</span></td>
                  <td><span class="text-nowrap">₸{{ product.price }}</span></td>
                  <td>
                    {% if product.assortment_group %}
                      <span class="badge rounded-pill bg-label-info">{{ product.assortment_group }}</span>
                    {% else %}
                      <span class="text-nowrap">—</span>
                    {% endif %}
                  </td>
                  <td><span class="text-nowrap">{{ product.branch_city.name|default:"—" }}</span></td>
                  <td><span class="text-nowrap">{{ product.created_at|date:"d M Y, H:i" }}</span></td>
                  <td>
                    <div class="d-flex align-items-center">
                      <span class="text-nowrap">
                        <a href="{% url 'products:edit_product' product.id %}" class="btn btn-icon btn-text-secondary rounded-pill me-1" title="Редактировать">
                          <i class="icon-base ri ri-edit-box-line icon-22px"></i>
                        </a>
                        <button type="button" class="btn btn-sm btn-icon btn-text-secondary rounded-pill text-body waves-effect btn-delete-product"
                                data-product-id="{{ product.id }}" data-product-name="{{ product.name }}" title="Удалить">
                          <i class="icon-base ri ri-delete-bin-7-line icon-22px"></i>
                        </button>
                      </span>
                    </div>
                  </td>
                </tr>
                {% empty %}
                <tr><td colspan="8" class="text-center text-muted py-5">Товары не найдены</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>

        <!-- Пагинация внизу -->
        <div class="row mx-3 justify-content-between align-items-center mt-4">
          <div class="col-md-6">
            <div class="d-flex align-items-center">
              <span class="me-3">Показать:</span>
              <select class="form-select form-select-sm" style="width: auto;" onchange="changePerPage(this.value)">
                <option value="10" {% if per_page == 10 %}selected{% endif %}>10</option>
                <option value="25" {% if per_page == 25 %}selected{% endif %}>25</option>
                <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
                <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
              </select>
              <span class="ms-3 text-muted">
                {% if products.paginator %}
                  Показано {{ products.start_index }}-{{ products.end_index }} из {{ products.paginator.count }} записей
                {% else %}
                  Показано 1-{{ products|length }} из {{ products|length }} записей
                {% endif %}
              </span>
            </div>
          </div>
          <div class="col-md-6">
            <div class="d-flex justify-content-end">
              {% if products.has_other_pages %}
              <nav aria-label="pagination">
                <ul class="pagination mb-0">
                  <li class="page-item {% if not products.has_previous %}disabled{% endif %}">
                    {% if products.has_previous %}
                      <a class="page-link" href="?page=1{% if per_page %}&per_page={{ per_page }}{% endif %}" aria-label="Первая">
                        <i class="ri-skip-back-mini-line"></i>
                      </a>
                    {% else %}
                      <span class="page-link">
                        <i class="ri-skip-back-mini-line"></i>
                      </span>
                    {% endif %}
                  </li>
                  <li class="page-item {% if not products.has_previous %}disabled{% endif %}">
                    {% if products.has_previous %}
                      <a class="page-link" href="?page={{ products.previous_page_number }}{% if per_page %}&per_page={{ per_page }}{% endif %}" aria-label="Предыдущая">
                        <i class="ri-arrow-left-s-line"></i>
                      </a>
                    {% else %}
                      <span class="page-link">
                        <i class="ri-arrow-left-s-line"></i>
                      </span>
                    {% endif %}
                  </li>
                  {% for num in products.paginator.page_range %}
                    {% if num == products.number %}
                      <li class="page-item active">
                        <span class="page-link">{{ num }}</span>
                      </li>
                    {% elif num > products.number|add:'-3' and num < products.number|add:'3' %}
                      <li class="page-item">
                        <a class="page-link" href="?page={{ num }}{% if per_page %}&per_page={{ per_page }}{% endif %}">{{ num }}</a>
                      </li>
                    {% endif %}
                  {% endfor %}
                  <li class="page-item {% if not products.has_next %}disabled{% endif %}">
                    {% if products.has_next %}
                      <a class="page-link" href="?page={{ products.next_page_number }}{% if per_page %}&per_page={{ per_page }}{% endif %}" aria-label="Следующая">
                        <i class="ri-arrow-right-s-line"></i>
                      </a>
                    {% else %}
                      <span class="page-link">
                        <i class="ri-arrow-right-s-line"></i>
                      </span>
                    {% endif %}
                  </li>
                  <li class="page-item {% if not products.has_next %}disabled{% endif %}">
                    {% if products.has_next %}
                      <a class="page-link" href="?page={{ products.paginator.num_pages }}{% if per_page %}&per_page={{ per_page }}{% endif %}" aria-label="Последняя">
                        <i class="ri-skip-forward-mini-line"></i>
                      </a>
                    {% else %}
                      <span class="page-link">
                        <i class="ri-skip-forward-mini-line"></i>
                      </span>
                    {% endif %}
                  </li>
                </ul>
              </nav>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Update products modal -->
  <div class="modal fade" id="updateProductsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Обновление товаров</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="excelFile" class="form-label">Выберите Excel файл</label>
            <input type="file" class="form-control" id="excelFile" accept=".xlsx,.xls" />
            <div class="form-text">Поддерживаются файлы Excel (.xlsx, .xls)</div>
          </div>
          <div class="mb-3">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="clearExisting" />
              <label class="form-check-label" for="clearExisting">
                Очистить существующие товары перед импортом
              </label>
            </div>
          </div>
          <div class="mb-3">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="limitRows" />
              <label class="form-check-label" for="limitRows">
                Ограничить количество строк
              </label>
            </div>
            <div class="mt-2" id="limitInputContainer" style="display: none;">
              <input type="number" class="form-control" id="limitRowsInput" placeholder="Количество строк" min="1" max="50000" />
            </div>
          </div>
          <div id="uploadProgress" class="d-none">
            <div class="progress mb-3">
              <div class="progress-bar" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
            <div class="text-center">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Загрузка...</span>
              </div>
              <p class="mt-2 mb-0">Обновление товаров...</p>
            </div>
          </div>
          <div id="uploadResult" class="d-none">
            <div class="alert alert-success">
              <h6 class="alert-heading">Импорт завершен успешно!</h6>
              <div id="importStats"></div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-label-secondary" data-bs-dismiss="modal">Отмена</button>
          <button type="button" class="btn btn-primary" id="startImportBtn" disabled>
            <i class="ri-upload-line me-2"></i>
            Начать импорт
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Delete confirmation modal -->
  <div class="modal fade" id="deleteProductModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Подтверждение удаления</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p class="mb-0">Удалить товар <strong id="delete-product-name"></strong>? Это действие нельзя отменить.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-label-secondary" data-bs-dismiss="modal">Отмена</button>
          <button type="button" class="btn btn-danger" id="confirm-delete-btn">Удалить</button>
        </div>
      </div>
    </div>
  </div>

  <script>
  function changePerPage(value) {
    const url = new URL(window.location);
    url.searchParams.set('per_page', value);
    url.searchParams.set('page', '1');
    window.location.href = url.toString();
  }

  (function() {
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
    }

    // Update products functionality
    const updateBtn = document.getElementById('updateProductsBtn');
    const updateModal = document.getElementById('updateProductsModal');
    const excelFileInput = document.getElementById('excelFile');
    const startImportBtn = document.getElementById('startImportBtn');
    const clearExistingCheckbox = document.getElementById('clearExisting');
    const limitRowsCheckbox = document.getElementById('limitRows');
    const limitInputContainer = document.getElementById('limitInputContainer');
    const limitRowsInput = document.getElementById('limitRowsInput');
    const uploadProgress = document.getElementById('uploadProgress');
    const uploadResult = document.getElementById('uploadResult');
    const importStats = document.getElementById('importStats');

    // Open modal when update button is clicked
    updateBtn.addEventListener('click', function() {
      const modal = new bootstrap.Modal(updateModal);
      modal.show();
    });

    // Enable/disable start button based on file selection
    excelFileInput.addEventListener('change', function() {
      startImportBtn.disabled = !this.files.length;
    });

    // Show/hide limit input
    limitRowsCheckbox.addEventListener('change', function() {
      limitInputContainer.style.display = this.checked ? 'block' : 'none';
    });

    // Start import process
    startImportBtn.addEventListener('click', function() {
      const file = excelFileInput.files[0];
      if (!file) return;

      // Show progress
      uploadProgress.classList.remove('d-none');
      uploadResult.classList.add('d-none');
      startImportBtn.disabled = true;

      // Prepare form data
      const formData = new FormData();
      formData.append('file', file);
      formData.append('clear_existing', clearExistingCheckbox.checked);
      if (limitRowsCheckbox.checked && limitRowsInput.value) {
        formData.append('limit', limitRowsInput.value);
      }

      // Start import
      fetch('/products/import/', {
        method: 'POST',
        headers: {
          'X-CSRFToken': getCookie('csrftoken')
        },
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        uploadProgress.classList.add('d-none');
        uploadResult.classList.remove('d-none');
        
        if (data.status === 'success') {
          importStats.innerHTML = `
            <p class="mb-1"><strong>Создано товаров:</strong> ${data.created || 0}</p>
            <p class="mb-1"><strong>Обновлено товаров:</strong> ${data.updated || 0}</p>
            <p class="mb-1"><strong>Удалено товаров:</strong> ${data.deleted || 0}</p>
            <p class="mb-0"><strong>Всего обработано:</strong> ${(data.created || 0) + (data.updated || 0) + (data.deleted || 0)}</p>
          `;
          
          // Reload page after 3 seconds
          setTimeout(() => {
            window.location.reload();
          }, 3000);
        } else {
          uploadResult.innerHTML = `
            <div class="alert alert-danger">
              <h6 class="alert-heading">Ошибка импорта</h6>
              <p class="mb-0">${data.message || 'Произошла ошибка при импорте'}</p>
            </div>
          `;
        }
      })
      .catch(error => {
        uploadProgress.classList.add('d-none');
        uploadResult.classList.remove('d-none');
        uploadResult.innerHTML = `
          <div class="alert alert-danger">
            <h6 class="alert-heading">Ошибка</h6>
            <p class="mb-0">Сетевая ошибка: ${error.message}</p>
          </div>
        `;
      })
      .finally(() => {
        startImportBtn.disabled = false;
      });
    });

    // Delete product functionality
    const modalEl = document.getElementById('deleteProductModal');
    const nameEl = document.getElementById('delete-product-name');
    const confirmBtn = document.getElementById('confirm-delete-btn');
    let currentProductId = null;

    document.addEventListener('click', function(e) {
      const btn = e.target.closest('.btn-delete-product');
      if (!btn) return;
      currentProductId = btn.getAttribute('data-product-id');
      nameEl.textContent = btn.getAttribute('data-product-name') || '';
      const modal = new bootstrap.Modal(modalEl);
      modal.show();
    });

    confirmBtn.addEventListener('click', function() {
      if (!currentProductId) return;
      const url = `/products/delete/${currentProductId}/`;
      fetch(url, {
        method: 'POST',
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'X-CSRFToken': getCookie('csrftoken')
        }
      }).then(r => r.json())
        .then(data => {
          if (data.status === 'success') {
            const row = document.querySelector(`[data-product-id="${currentProductId}"]`)?.closest('tr');
            if (row) row.remove();
            else window.location.reload();
            bootstrap.Modal.getInstance(modalEl).hide();
            
            if (window.showNotification) {
              window.showNotification(data.message || 'Товар успешно удалён', 'success');
            }
          } else {
            if (window.showNotification) {
              window.showNotification(data.message || 'Ошибка удаления', 'error');
            }
          }
        })
        .catch(() => {
          if (window.showNotification) {
            window.showNotification('Сетевая ошибка', 'error');
          }
        });
    });
  })();
  </script>
{% endblock %}

