{% extends 'base.html' %}

{% block title %}Пользователи{% endblock %}

{% block content %}
  <div class="card">
    <div class="card-datatable">
      <div id="DataTables_Table_0_wrapper" class="dt-container dt-bootstrap5 dt-empty-footer">
        <div class="row mx-2">
          <div class="d-md-flex justify-content-between align-items-center dt-layout-start col-md-auto me-auto mt-0 px-5">
            <div class="dt-length mb-0 mb-md-5">
              <label for="dt-length-0">Show</label>
              <select class="form-select form-select-sm" id="dt-length-0" onchange="window.location.href = '?page=1&length=' + this.value;">
                <option value="10" {% if users.per_page == 10 %}selected{% endif %}>10</option>
                <option value="25" {% if users.per_page == 25 %}selected{% endif %}>25</option>
                <option value="50" {% if users.per_page == 50 %}selected{% endif %}>50</option>
                <option value="100" {% if users.per_page == 100 %}selected{% endif %}>100</option>
              </select>
            </div>
          </div>
          <div class="align-items-center dt-layout-end col-md-auto ms-auto justify-content-md-between justify-content-center d-flex">
            <div class="dt-search me-4">
              <input type="search" class="form-control form-control-sm" id="dt-search-0" placeholder="Поиск пользователя">
              <label for="dt-search-0"></label>
            </div>
            <div class="dt-buttons btn-group flex-wrap mb-0 w-auto">
              <a href="{% url 'accounts:add_user' %}" class="btn add-new btn-primary">
                <span>
                  <i class="icon-base ri ri-add-line icon-sm me-0 me-sm-1"></i>
                  <span class="d-none d-sm-inline-block">Добавить пользователя</span>
                </span>
              </a>
            </div>
          </div>
        </div>

        <div class="justify-content-between dt-layout-table">
          <div class="d-md-flex justify-content-between align-items-center dt-layout-full table-responsive">
            <table class="datatables-permissions table dataTable dtr-column" id="DataTables_Table_0" style="width: 100%;">
              <thead>
                <tr>
                  <th>Логин</th>
                  <th>Имя</th>
                  <th>Фамилия</th>
                  <th>Email</th>
                  <th class="text-end">Действия</th>
                </tr>
              </thead>
              <tbody>
                {% for u in users %}
                <tr>
                  <td>{{ u.username }}</td>
                  <td>{{ u.first_name }}</td>
                  <td>{{ u.last_name }}</td>
                  <td>{{ u.email }}</td>
                  <td class="text-end">
                    <a href="{% url 'accounts:edit_user' u.id %}" class="btn btn-icon btn-text-secondary rounded-pill me-1" title="Редактировать">
                      <i class="icon-base ri ri-edit-box-line icon-22px"></i>
                    </a>
                  </td>
                </tr>
                {% empty %}
                <tr><td colspan="4" class="text-center text-muted py-5">Пользователи не найдены</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>

        <div class="row mx-3 justify-content-between">
          <div class="d-md-flex justify-content-between align-items-center dt-layout-start col-md-auto me-auto mt-0 px-5">
            <div class="dt-info" aria-live="polite" id="DataTables_Table_0_info" role="status">
              Показано {{ users.start_index }} - {{ users.end_index }} из {{ users.paginator.count }} записей
            </div>
          </div>
          <div class="align-items-center dt-layout-end col-md-auto ms-auto justify-content-md-between justify-content-center d-flex">
            <div class="dt-paging">
              {% if users.has_other_pages %}
              <nav aria-label="pagination">
                <ul class="pagination">
                  <li class="dt-paging-button page-item {% if not users.has_previous %}disabled{% endif %}">
                    <a class="page-link first" href="?page=1" aria-label="First"><i class="icon-base ri ri-skip-back-mini-line scaleX-n1-rtl icon-22px"></i></a>
                  </li>
                  <li class="dt-paging-button page-item {% if not users.has_previous %}disabled{% endif %}">
                    {% if users.has_previous %}
                      <a class="page-link previous" href="?page={{ users.previous_page_number }}" aria-label="Previous"><i class="icon-base ri ri-arrow-left-s-line scaleX-n1-rtl icon-22px"></i></a>
                    {% else %}
                      <span class="page-link previous" aria-disabled="true"><i class="icon-base ri ri-arrow-left-s-line scaleX-n1-rtl icon-22px"></i></span>
                    {% endif %}
                  </li>
                  <li class="dt-paging-button page-item active"><span class="page-link">{{ users.number }}</span></li>
                  <li class="dt-paging-button page-item {% if not users.has_next %}disabled{% endif %}">
                    {% if users.has_next %}
                      <a class="page-link next" href="?page={{ users.next_page_number }}" aria-label="Next"><i class="icon-base ri ri-arrow-right-s-line scaleX-n1-rtl icon-22px"></i></a>
                    {% else %}
                      <span class="page-link next" aria-disabled="true"><i class="icon-base ri ri-arrow-right-s-line scaleX-n1-rtl icon-22px"></i></span>
                    {% endif %}
                  </li>
                  <li class="dt-paging-button page-item {% if not users.has_next %}disabled{% endif %}">
                    <a class="page-link last" href="?page={{ users.paginator.num_pages }}" aria-label="Last"><i class="icon-base ri ri-skip-forward-mini-line scaleX-n1-rtl icon-22px"></i></a>
                  </li>
                </ul>
              </nav>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
  (function(){
    const searchInput = document.getElementById('dt-search-0');
    const table = document.getElementById('DataTables_Table_0');
    if (!searchInput || !table) return;
    const tbody = table.querySelector('tbody');
    function norm(t){ return (t||'').toString().toLowerCase().trim(); }
    function filter(q){
      const rows = Array.from(tbody.querySelectorAll('tr'));
      const n = norm(q);
      rows.forEach(tr => {
        const tds = tr.querySelectorAll('td');
        if (tds.length < 4) return;
        const login = norm(tds[0].innerText);
        const first = norm(tds[1].innerText);
        const last = norm(tds[2].innerText);
        const mail = norm(tds[3].innerText);
        tr.style.display = n === '' || (login+first+last+mail).includes(n) ? '' : 'none';
      });
    }
    searchInput.addEventListener('input', e => filter(e.target.value));
  })();
  </script>
{% endblock %}

