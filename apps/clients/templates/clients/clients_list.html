{% extends 'base.html' %}
{% load client_filters %}

{% block title %}Клиенты{% endblock %}

{% block extra_css %}
<style>
  input[type="search"]::-webkit-search-cancel-button {
    -webkit-appearance: none;
    display: none;
  }
  input[type="search"]::-ms-clear {
    display: none;
  }
</style>
{% endblock %}

{% block content %}
<div class="container-xxl flex-grow-1 container-p-y">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h4 class="mb-0">Список клиентов</h4>
  <a href="{% url 'clients:add_client' %}" class="btn btn-primary">
    <i class="icon-base ri ri-add-line me-1"></i>
    Добавить клиента
  </a>
  </div>
  <div class="card">
    <div class="card-body">
      <!-- Пагинация сверху -->
      <div class="d-flex justify-content-between align-items-center mb-4">
        <div class="d-flex align-items-center">
          <span class="me-3">Показать:</span>
          <select name="per_page" class="form-select form-select-sm" style="width: auto;" onchange="changePerPage(this.value)">
            <option value="10" {% if per_page == 10 %}selected{% endif %}>10</option>
            <option value="25" {% if per_page == 25 %}selected{% endif %}>25</option>
            <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
            <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
          </select>
          <span class="ms-3 text-muted">
            {% if clients.paginator %}
              Показано {{ clients.start_index }}-{{ clients.end_index }} из {{ clients.paginator.count }} записей
            {% else %}
              Показано 1-{{ clients|length }} из {{ clients|length }} записей
            {% endif %}
          </span>
        </div>
        <div class="d-flex align-items-center">
          <div class="me-3">
            <form method="get" class="d-inline">
              <div class="input-group">
                <input type="search" class="form-control form-control-sm" name="search" placeholder="Поиск: телефон или ФИО/компания" value="{{ request.GET.search }}" style="width: 300px;" autocomplete="off">
                <button class="btn btn-outline-primary btn-sm" type="submit">
                  <i class="ri-search-line"></i>
                </button>
                {% if request.GET.search %}
                  <a href="{% url 'clients:clients_list' %}" class="btn btn-outline-secondary btn-sm">
                    <i class="ri-close-line"></i>
                  </a>
                {% endif %}
              </div>
              <!-- Сохраняем другие параметры -->
              {% if request.GET.per_page %}
                <input type="hidden" name="per_page" value="{{ request.GET.per_page }}">
              {% endif %}
              {% if request.GET.sort %}
                <input type="hidden" name="sort" value="{{ request.GET.sort }}">
              {% endif %}
              {% if request.GET.order %}
                <input type="hidden" name="order" value="{{ request.GET.order }}">
              {% endif %}
            </form>
          </div>
          <div class="d-flex gap-2">
            <button type="button" class="btn btn-outline-primary" id="import-excel-btn">
              <i class="icon-base ri ri-file-excel-line me-1"></i>
              Загрузить из Excel
            </button>
          </div>
        </div>
      </div>

      <!-- Таблица клиентов -->
      <div class="table-responsive">
            <table class="table table-hover table-sm">
              <thead class="table-dark sticky-top">
                <tr>
                  <th>Действия</th>
                  <th>
                    <a href="?sort=name&order={% if current_sort == 'name' and current_order == 'asc' %}desc{% else %}asc{% endif %}" 
                       class="text-decoration-none text-body">
                      Имя/Компания
                      {% if current_sort == 'name' %}
                        {% if current_order == 'asc' %}
                          <i class="icon-base ri ri-arrow-up-line ms-1"></i>
                        {% else %}
                          <i class="icon-base ri ri-arrow-down-line ms-1"></i>
                        {% endif %}
                      {% endif %}
                    </a>
                  </th>
                  <th>
                    <a href="?sort=client_type&order={% if current_sort == 'client_type' and current_order == 'asc' %}desc{% else %}asc{% endif %}" 
                       class="text-decoration-none text-body">
                      Тип
                      {% if current_sort == 'client_type' %}
                        {% if current_order == 'asc' %}
                          <i class="icon-base ri ri-arrow-up-line ms-1"></i>
                        {% else %}
                          <i class="icon-base ri ri-arrow-down-line ms-1"></i>
                        {% endif %}
                      {% endif %}
                    </a>
                  </th>
                  <th>
                    <a href="?sort=phone&order={% if current_sort == 'phone' and current_order == 'asc' %}desc{% else %}asc{% endif %}" 
                       class="text-decoration-none text-body">
                      Телефон
                      {% if current_sort == 'phone' %}
                        {% if current_order == 'asc' %}
                          <i class="icon-base ri ri-arrow-up-line ms-1"></i>
                        {% else %}
                          <i class="icon-base ri ri-arrow-down-line ms-1"></i>
                        {% endif %}
                      {% endif %}
                    </a>
                  </th>
                  <th>
                    <a href="?sort=city&order={% if current_sort == 'city' and current_order == 'asc' %}desc{% else %}asc{% endif %}" 
                       class="text-decoration-none text-body">
                      Город
                      {% if current_sort == 'city' %}
                        {% if current_order == 'asc' %}
                          <i class="icon-base ri ri-arrow-up-line ms-1"></i>
                        {% else %}
                          <i class="icon-base ri ri-arrow-down-line ms-1"></i>
                        {% endif %}
                      {% endif %}
                    </a>
                  </th>
                  <th>
                    <a href="?sort=created_at&order={% if current_sort == 'created_at' and current_order == 'asc' %}desc{% else %}asc{% endif %}" 
                       class="text-decoration-none text-body">
                      Создан
                      {% if current_sort == 'created_at' %}
                        {% if current_order == 'asc' %}
                          <i class="icon-base ri ri-arrow-up-line ms-1"></i>
                        {% else %}
                          <i class="icon-base ri ri-arrow-down-line ms-1"></i>
                        {% endif %}
                      {% endif %}
                    </a>
                  </th>
                </tr>
              </thead>
              <tbody id="clients-tbody">
                {% for client in clients %}
                <tr data-name="{{ client.name|lower }}" data-phone="{% if client.phones.first %}{{ client.phones.first.phone }}{% else %}{% endif %}">
                  <td>
                    <div class="d-flex align-items-center">
                      <span class="text-nowrap">
                        <a href="{% url 'clients:edit_client' client.id %}" class="btn btn-icon btn-text-secondary rounded-pill me-1" title="Редактировать">
                          <i class="icon-base ri ri-edit-box-line icon-22px"></i>
                        </a>
                        <button type="button" class="btn btn-sm btn-icon btn-text-secondary rounded-pill text-body waves-effect btn-delete-client"
                                data-client-id="{{ client.id }}" data-client-name="{{ client.name }}" title="Удалить">
                          <i class="icon-base ri ri-delete-bin-7-line icon-22px"></i>
                        </button>
                      </span>
                    </div>
                  </td>
                  <td><span class="text-nowrap text-heading">{{ client.name }}</span></td>
                  <td>
                    {% if client.client_type == 'individual' %}
                      <span class="badge rounded-pill bg-label-success">Физ. лицо</span>
                    {% else %}
                      <span class="badge rounded-pill bg-label-danger">Юр. лицо</span>
                    {% endif %}
                  </td>
                  <td><span class="text-nowrap">{% if client.phones.first %}{{ client.phones.first.phone|format_phone }}{% else %}—{% endif %}</span></td>
                  <td><span class="text-nowrap">{% if client.addresses.first %}{{ client.addresses.first.city }}{% else %}—{% endif %}</span></td>
                  <td><span class="text-nowrap">{{ client.created_at|date:"d M Y, H:i" }}</span></td>
                </tr>
                {% empty %}
                <tr><td colspan="6" class="text-center text-muted py-5">Клиенты не найдены</td></tr>
                {% endfor %}
              </tbody>
            </table>
      </div>

      <!-- Пагинация внизу -->
      <nav aria-label="Page navigation" class="mt-4">
        <ul class="pagination justify-content-center">
          {% if clients.has_previous %}
            <li class="page-item">
              <a class="page-link" href="?page=1{% if per_page %}&per_page={{ per_page }}{% endif %}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.sort %}&sort={{ request.GET.sort }}{% endif %}{% if request.GET.order %}&order={{ request.GET.order }}{% endif %}">Первая</a>
            </li>
            <li class="page-item">
              <a class="page-link" href="?page={{ clients.previous_page_number }}{% if per_page %}&per_page={{ per_page }}{% endif %}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.sort %}&sort={{ request.GET.sort }}{% endif %}{% if request.GET.order %}&order={{ request.GET.order }}{% endif %}">Предыдущая</a>
            </li>
          {% endif %}

          {% for num in clients.paginator.page_range %}
            {% if num == clients.number %}
              <li class="page-item active">
                <span class="page-link">{{ num }}</span>
              </li>
            {% elif num > clients.number|add:'-3' and num < clients.number|add:'3' %}
              <li class="page-item">
                <a class="page-link" href="?page={{ num }}{% if per_page %}&per_page={{ per_page }}{% endif %}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.sort %}&sort={{ request.GET.sort }}{% endif %}{% if request.GET.order %}&order={{ request.GET.order }}{% endif %}">{{ num }}</a>
              </li>
            {% endif %}
          {% endfor %}

          {% if clients.has_next %}
            <li class="page-item">
              <a class="page-link" href="?page={{ clients.next_page_number }}{% if per_page %}&per_page={{ per_page }}{% endif %}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.sort %}&sort={{ request.GET.sort }}{% endif %}{% if request.GET.order %}&order={{ request.GET.order }}{% endif %}">Следующая</a>
            </li>
            <li class="page-item">
              <a class="page-link" href="?page={{ clients.paginator.num_pages }}{% if per_page %}&per_page={{ per_page }}{% endif %}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.sort %}&sort={{ request.GET.sort }}{% endif %}{% if request.GET.order %}&order={{ request.GET.order }}{% endif %}">Последняя</a>
            </li>
          {% endif %}
        </ul>
      </nav>
    </div>
  </div>
</div>

  <!-- Import Excel Modal -->
  <div class="modal fade" id="importExcelModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Загрузка клиентов из Excel</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="excel-file" class="form-label">Выберите Excel файл</label>
            <input type="file" class="form-control" id="excel-file" accept=".xlsx,.xls">
            <div class="form-text">
              Поддерживаются файлы .xlsx и .xls. Обязательные колонки: Телефон, Тип клиента, ФИО/Компания
            </div>
          </div>
          <div class="alert alert-info">
            <h6><i class="ri-information-line me-2"></i>Формат Excel файла:</h6>
            <div class="row">
              <div class="col-md-6">
                <h6 class="text-primary">Обязательные колонки:</h6>
                <ul class="mb-2">
                  <li><strong>Телефон</strong> - основной телефон клиента</li>
                  <li><strong>Тип клиента</strong> - "Физическое лицо" или "Юридическое лицо"</li>
                  <li><strong>ФИО/Компания</strong> - полное имя или название компании</li>
                </ul>
              </div>
              <div class="col-md-6">
                <h6 class="text-secondary">Дополнительные колонки:</h6>
                <ul class="mb-0">
                  <li><strong>Телефон 2</strong> - дополнительный телефон</li>
                  <li><strong>Email</strong> - email адрес</li>
                  <li><strong>Фамилия, Имя, Отчество</strong> - для физических лиц</li>
                  <li><strong>Город</strong> - город клиента</li>
                </ul>
              </div>
            </div>
            <div class="alert alert-warning mt-2 mb-0">
              <small><i class="ri-lightbulb-line me-1"></i><strong>Важно:</strong> Существующие клиенты будут обновлены, новые - созданы.</small>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-label-secondary" data-bs-dismiss="modal">Отмена</button>
          <button type="button" class="btn btn-primary" id="confirm-import-btn" disabled>
            <i class="ri-upload-line me-1"></i>Загрузить
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Import Results Modal -->
  <div class="modal fade" id="importResultsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Результаты импорта</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="import-results-body">
          <!-- Результаты будут загружены динамически -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Закрыть</button>
        </div>
      </div>
    </div>
  </div>
  <div class="modal fade" id="deleteClientModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Подтверждение удаления</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p class="mb-0">Удалить клиента <strong id="delete-client-name"></strong>? Это действие нельзя отменить.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-label-secondary" data-bs-dismiss="modal">Отмена</button>
          <button type="button" class="btn btn-danger" id="confirm-delete-btn">Удалить</button>
        </div>
      </div>
    </div>
  </div>

<script>
function changePerPage(value) {
  const url = new URL(window.location);
  url.searchParams.set('per_page', value);
  url.searchParams.set('page', '1');
  window.location.href = url.toString();
}
</script>

  <script>
  (function() {

    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
    }

    const modalEl = document.getElementById('deleteClientModal');
    const nameEl = document.getElementById('delete-client-name');
    const confirmBtn = document.getElementById('confirm-delete-btn');
    let currentClientId = null;

    document.addEventListener('click', function(e) {
      const btn = e.target.closest('.btn-delete-client');
      if (!btn) return;
      currentClientId = btn.getAttribute('data-client-id');
      nameEl.textContent = btn.getAttribute('data-client-name') || '';
      const modal = new bootstrap.Modal(modalEl);
      modal.show();
    });

    confirmBtn.addEventListener('click', function() {
      if (!currentClientId) return;
      const url = `/clients/delete/${currentClientId}/`;
      fetch(url, {
        method: 'POST',
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'X-CSRFToken': getCookie('csrftoken')
        }
      }).then(r => r.json())
        .then(data => {
          if (data.status === 'success') {
            // remove row or reload
            const row = document.querySelector(`[data-client-id="${currentClientId}"]`)?.closest('tr');
            if (row) row.remove();
            else window.location.reload();
            bootstrap.Modal.getInstance(modalEl).hide();
            
            // Показать уведомление об успехе
            if (window.showNotification) {
              window.showNotification(data.message || 'Клиент успешно удален', 'success');
            }
          } else {
            if (window.showNotification) {
              window.showNotification(data.message || 'Ошибка удаления', 'error');
            }
          }
        })
        .catch(() => {
          if (window.showNotification) {
            window.showNotification('Сетевая ошибка', 'error');
          }
        });
    });
    // Поиск теперь через форму, обработка не требуется

    // Обработка импорта Excel
    const importBtn = document.getElementById('import-excel-btn');
    const importModal = document.getElementById('importExcelModal');
    const confirmImportBtn = document.getElementById('confirm-import-btn');
    const excelFileInput = document.getElementById('excel-file');
    const importResultsModal = document.getElementById('importResultsModal');
    const importResultsBody = document.getElementById('import-results-body');

    // Открытие модального окна импорта
    importBtn.addEventListener('click', function() {
      const modal = new bootstrap.Modal(importModal);
      modal.show();
    });

    // Активация кнопки загрузки при выборе файла
    excelFileInput.addEventListener('change', function() {
      confirmImportBtn.disabled = !this.files.length;
    });

    // Обработка загрузки файла
    confirmImportBtn.addEventListener('click', function() {
      const file = excelFileInput.files[0];
      if (!file) return;

      // Показываем индикатор загрузки
      this.disabled = true;
      this.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Загрузка...';

      const formData = new FormData();
      formData.append('excel_file', file);

      fetch('{% url "clients:import_clients_excel" %}', {
        method: 'POST',
        headers: {
          'X-CSRFToken': getCookie('csrftoken')
        },
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        // Скрываем модальное окно импорта
        bootstrap.Modal.getInstance(importModal).hide();
        
        // Показываем результаты
        showImportResults(data);
        
        // Обновляем страницу если импорт был успешным
        if (data.status === 'success' && data.imported > 0) {
          setTimeout(() => {
            window.location.reload();
          }, 2000);
        }
      })
      .catch(error => {
        console.error('Ошибка импорта:', error);
        showImportResults({
          status: 'error',
          message: 'Ошибка загрузки файла'
        });
      })
      .finally(() => {
        // Восстанавливаем кнопку
        this.disabled = false;
        this.innerHTML = '<i class="ri-upload-line me-1"></i>Загрузить';
        excelFileInput.value = '';
      });
    });

    // Функция показа результатов импорта
    function showImportResults(data) {
      let html = '';
      
      if (data.status === 'success') {
        html = `
          <div class="alert alert-success">
            <h6><i class="ri-check-circle-line me-2"></i>Импорт завершен успешно!</h6>
            <p class="mb-0">${data.message}</p>
          </div>
          <div class="row">
            <div class="col-md-4">
              <div class="card">
                <div class="card-body">
                  <h6 class="card-title text-success">Обработано</h6>
                  <h3 class="text-success">${data.imported}</h3>
                  <small class="text-muted">Клиентов обновлено/создано</small>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="card">
                <div class="card-body">
                  <h6 class="card-title text-info">Всего строк</h6>
                  <h3 class="text-info">${(data.imported || 0) + (data.skipped || 0)}</h3>
                  <small class="text-muted">В файле</small>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="card">
                <div class="card-body">
                  <h6 class="card-title text-warning">Пропущено</h6>
                  <h3 class="text-warning">${data.skipped || 0}</h3>
                  <small class="text-muted">Ошибки/пустые</small>
                </div>
              </div>
            </div>
          </div>
        `;
        
        if (data.skipped > 0) {
          html += `
            <div class="mt-3">
              <h6><i class="ri-information-line me-1"></i>Детали пропущенных записей:</h6>
              <div class="row">
                <div class="col-md-6">
                  <div class="d-flex align-items-center mb-2">
                    <i class="ri-file-text-line me-2 text-muted"></i>
                    <span class="text-muted">Пустые строки:</span>
                    <strong class="ms-2">${data.empty_rows || 0}</strong>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="d-flex align-items-center mb-2">
                    <i class="ri-error-warning-line me-2 text-muted"></i>
                    <span class="text-muted">Неверный тип:</span>
                    <strong class="ms-2">${data.invalid_type || 0}</strong>
                  </div>
                </div>
              </div>
            </div>
          `;
        }
        
        if (data.errors && data.errors.length > 0) {
          html += `
            <div class="mt-3">
              <h6 class="text-danger"><i class="ri-error-warning-line me-1"></i>Ошибки:</h6>
              <div class="alert alert-danger">
                <ul class="mb-0">
                  ${data.errors.map(error => `<li><i class="ri-error-warning-line me-1"></i>${error}</li>`).join('')}
                </ul>
              </div>
            </div>
          `;
        }
      } else {
        html = `
          <div class="alert alert-danger">
            <h6><i class="ri-error-warning-line me-2"></i>Ошибка импорта</h6>
            <p class="mb-0">${data.message}</p>
          </div>
        `;
      }
      
      importResultsBody.innerHTML = html;
      const modal = new bootstrap.Modal(importResultsModal);
      modal.show();
    }

  })();
  </script>
{% endblock %}



