{% extends 'base.html' %}
{% load static %}
{% load dashboard_filters %}
{% load order_extras %}

{% block title %}Dashboard - CRM —Å–∏—Å—Ç–µ–º–∞{% endblock %}

{% block content %}
<div class="container-xxl flex-grow-1 container-p-y">
  <!-- 
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex justify-content-end">
        <div class="dropdown">
          <button class="btn btn-outline-primary dropdown-toggle" type="button" id="rangeDropdown" data-bs-toggle="dropdown" aria-expanded="false">
            –ü–µ—Ä–∏–æ–¥
          </button>
          <div class="dropdown-menu dropdown-menu-end p-3" aria-labelledby="rangeDropdown" style="min-width: 320px;">
            <form method="get" id="rangeForm" class="row g-2">
              <div class="col-12">
                <label class="form-label small mb-1">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞</label>
                <input type="date" class="form-control" name="start" value="{{ start }}">
              </div>
              <div class="col-12">
                <label class="form-label small mb-1">–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è</label>
                <input type="date" class="form-control" name="end" value="{{ end }}">
              </div>
              <div class="col-12 d-flex justify-content-between mt-2">
                <a href="?" class="btn btn-sm btn-outline-secondary">–°–±—Ä–æ—Å–∏—Ç—å</a>
                <button type="submit" class="btn btn-sm btn-primary">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
              </div>
              {# –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥—Ä—É–≥–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã, –µ—Å–ª–∏ –µ—Å—Ç—å #}
              {% if request.GET.sort %}
                <input type="hidden" name="sort" value="{{ request.GET.sort }}">
              {% endif %}
              {% if request.GET.order %}
                <input type="hidden" name="order" value="{{ request.GET.order }}">
              {% endif %}
              {% if request.GET.per_page %}
                <input type="hidden" name="per_page" value="{{ request.GET.per_page }}">
              {% endif %}
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
-->
  
  <div class="row gy-6">
    <!-- 
    <div class="col-xl-8 col-lg-7 align-self-end mt-md-7 mt-lg-4 pt-md-2 pt-lg-0">
      <div class="card">
        <div class="row">
          <div class="col-12 col-md-6">
            <div class="card-body">
              <h4 class="card-title mb-9 text-truncate">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å <span class="fw-bold">{{ user.first_name|default:user.username }}!</span>üéâ</h4>
              <p class="mb-0">–í—ã —É—Å–ø–µ—à–Ω–æ –≤–æ—à–ª–∏ –≤ CRM —Å–∏—Å—Ç–µ–º—É. –£–ø—Ä–∞–≤–ª—è–π—Ç–µ –∑–∞–∫–∞–∑–∞–º–∏, –∫–ª–∏–µ–Ω—Ç–∞–º–∏ –∏ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞–º–∏ —Å –ª–µ–≥–∫–æ—Å—Ç—å—é.</p>
            </div>
          </div>
          <div class="col-12 col-md-6 position-relative text-center">
            <img src="{% static 'frontend/assets/img/illustrations/illustration-john-2.png' %}" class="card-img-position bottom-0 w-auto end-0 scaleX-n1-rtl" alt="Dashboard" height="140">
          </div>
        </div>
      </div>
    </div>
  -->
    
    <!-- Plan Info Card -->
    <div class="col-xl-4 col-lg-5">
      <div class="card h-100">
        <div class="card-body">
          <h6 class="mb-3">–ü–ª–∞–Ω –∑–∞–∫–∞–∑–æ–≤</h6>
          
          {% if plan_progress %}
          <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø–ª–∞–Ω–∞ -->
          <div class="mb-3 p-3 bg-label-primary rounded">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <span class="small text-body-secondary">–ü–ª–∞–Ω: {{ plan_progress.plan_name }}</span>
              <span class="badge {% if plan_progress.is_completed %}bg-label-success{% else %}bg-label-warning{% endif %}">
                {% if plan_progress.is_completed %}‚úì –í—ã–ø–æ–ª–Ω–µ–Ω{% else %}–í –ø—Ä–æ—Ü–µ—Å—Å–µ{% endif %}
              </span>
            </div>
            <div class="d-flex justify-content-between align-items-center mb-2">
              <span class="small text-body-secondary">{{ plan_progress.plan_period }}</span>
              <span class="small fw-bold">{{ plan_progress.progress_percent }}%</span>
            </div>
            <div class="progress mb-2" style="height: 8px;">
              <div class="progress-bar {% if plan_progress.is_completed %}bg-success{% else %}bg-primary{% endif %}" 
                   role="progressbar" 
                   style="width: {{ plan_progress.progress_percent }}%" 
                   aria-valuenow="{{ plan_progress.progress_percent }}" 
                   aria-valuemin="0" 
                   aria-valuemax="100">
              </div>
            </div>
            <div class="d-flex justify-content-between align-items-center">
              <span class="small">–í—ã–ø–æ–ª–Ω–µ–Ω–æ: <strong>{{ plan_progress.completed }}</strong> –∏–∑ <strong>{{ plan_progress.plan_count }}</strong></span>
              <span class="small {% if plan_progress.remaining > 0 %}text-warning{% else %}text-success{% endif %}">
                –û—Å—Ç–∞–ª–æ—Å—å: <strong>{{ plan_progress.remaining }}</strong>
              </span>
            </div>
          </div>
          {% endif %}
          
          <div class="row g-3">
            <div class="col-6 col-md-3">
              <div class="d-flex flex-column">
                <span class="text-body-secondary small mb-1">–í—Å–µ–≥–æ</span>
                <h4 class="mb-0">{{ total_orders_count }}</h4>
                <small class="text-body-secondary">{{ total_orders_sum|spaced_thousands }} ‚Ç∏</small>
              </div>
            </div>
            <div class="col-6 col-md-3">
              <div class="d-flex flex-column">
                <span class="text-body-secondary small mb-1">–í—ã–ø–æ–ª–Ω–µ–Ω–æ</span>
                <h4 class="mb-0 text-success">{{ completed_count }}</h4>
                <small class="text-body-secondary">{{ completed_sum|spaced_thousands }} ‚Ç∏</small>
              </div>
            </div>
            <div class="col-6 col-md-3">
              <div class="d-flex flex-column">
                <span class="text-body-secondary small mb-1">–û—Ç–º–µ–Ω–µ–Ω–æ</span>
                <h4 class="mb-0 text-danger">{{ cancelled_count }}</h4>
                <small class="text-body-secondary">{{ cancelled_sum|spaced_thousands }} ‚Ç∏</small>
              </div>
            </div>
            <div class="col-6 col-md-3">
              <div class="d-flex flex-column">
                <span class="text-body-secondary small mb-1">–û—Å—Ç–∞–ª–æ—Å—å</span>
                <h4 class="mb-0 text-warning">{{ plan_progress.remaining }}</h4>
                <small class="text-body-secondary">{{ active_sum|spaced_thousands }} ‚Ç∏</small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!--/ Plan Info Card -->

    <!-- 
    <div class="col-xl-4 col-lg-5 col-md-6 col-12 mb-4">
      <div class="card h-100">
        <div class="card-body d-flex justify-content-between align-items-center flex-wrap">
          <div class="me-3">
            <h5 class="mb-1">–û–±—â–∏–µ –ø—Ä–æ–¥–∞–∂–∏</h5>
            <p class="mb-3">–ü–æ —Å—Ç–∞—Ç—É—Å–∞–º –∑–∞–∫–∞–∑–æ–≤</p>
            <div class="d-flex align-items-center">
              <h4 class="mb-0 me-1">‚Ç∏{{ revenue|spaced_thousands }}</h4>
              <p class="text-success mb-0"><i class="icon-base ri ri-arrow-up-s-line icon-24px"></i>+0%</p>
            </div>
          </div>
          <div id="totalSalesDonutChart" class="mt-3 mt-md-0" style="min-height: 97px;" 
               data-labels='{{ status_labels|safe }}' 
               data-values='{{ status_values|safe }}' 
               data-colors='{{ status_colors|safe }}'>
          </div>
        </div>
      </div>
    </div>
    -->
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–≥—Ä—É–∑–∏–ª–∞—Å—å –ª–∏ ApexCharts
    if (typeof ApexCharts === 'undefined') {
        console.error('ApexCharts –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω');
        return;
    }
    console.log('ApexCharts –∑–∞–≥—Ä—É–∂–µ–Ω —É—Å–ø–µ—à–Ω–æ');
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –ø–µ—Ä–∏–æ–¥–æ–≤
    const periodInputs = document.querySelectorAll('input[name="period"]');
    periodInputs.forEach(input => {
        input.addEventListener('change', function() {
            if (this.checked) {
                const url = new URL(window.location);
                url.searchParams.set('period', this.value);
                window.location.href = url.toString();
            }
        });
    });

    // –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏–∞–≥—Ä–∞–º–º—ã Total Sales
    const totalSalesChart = document.querySelector("#totalSalesDonutChart");
    if (totalSalesChart) {
        // –ß–∏—Ç–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ data-–∞—Ç—Ä–∏–±—É—Ç–æ–≤
        const statusLabels = JSON.parse(totalSalesChart.dataset.labels || '[]');
        const statusValues = JSON.parse(totalSalesChart.dataset.values || '[]');
        const statusColors = JSON.parse(totalSalesChart.dataset.colors || '[]');
        
        // –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
        console.log('Status Labels:', statusLabels);
        console.log('Status Values:', statusValues);
        console.log('Status Colors:', statusColors);
        console.log('Labels type:', typeof statusLabels);
        console.log('Values type:', typeof statusValues);
        console.log('Colors type:', typeof statusColors);
        
        // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Å—Ç–∞—Ç—É—Å—ã –≤ —á–∏—Ç–∞–µ–º—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è
        const statusNames = {
            'new': '–ù–æ–≤—ã–µ',
            'new_paid': '–ù–æ–≤—ã–µ –æ–ø–ª–∞—á–µ–Ω–Ω—ã–µ',
            'reserve': '–†–µ–∑–µ—Ä–≤',
            'transfer': '–ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ',
            'delivery': '–î–æ—Å—Ç–∞–≤–∫–∞',
            'callback': '–ü–µ—Ä–µ–∑–≤–æ–Ω–∏—Ç—å',
            'completed': '–í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ',
            'refund': '–í–æ–∑–≤—Ä–∞—Ç',
            'cancelled': '–û—Ç–º–µ–Ω–µ–Ω–Ω—ã–µ'
        };
        
        const labels = statusLabels.map(label => statusNames[label] || label);
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –¥–∏–∞–≥—Ä–∞–º–º—ã
        if (statusValues.length === 0 || statusValues.every(val => val === 0)) {
            console.log('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –¥–∏–∞–≥—Ä–∞–º–º—ã');
            totalSalesChart.innerHTML = '<div class="text-center text-muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>';
            return;
        }
        
        const options = {
            chart: {
                height: 100,
                width: 110,
                parentHeightOffset: 0,
                type: "donut"
            },
            labels: labels,
            series: statusValues,
            colors: statusColors,
            stroke: {
                width: 5,
                colors: ['#fff']
            },
            tooltip: {
                show: false,
                theme: 'light'
            },
            dataLabels: {
                enabled: false,
                formatter: function (val, opts) {
                    return parseInt(val) + "%"
                }
            },
            grid: {
                padding: {
                    top: -10,
                    right: -10,
                    left: -10,
                    bottom: -5
                }
            },
            legend: {
                show: false
            },
            plotOptions: {
                pie: {
                    donut: {
                        size: "75%",
                        labels: {
                            show: true,
                            value: {
                                fontSize: "1.15rem",
                                fontFamily: "Inter",
                                color: "var(--bs-heading-color)",
                                fontWeight: 500,
                                offsetY: -18,
                                formatter: function (val) {
                                    return parseInt(val) + "%"
                                }
                            },
                            name: {
                                offsetY: 18,
                                fontFamily: "Inter"
                            },
                            total: {
                                label: "",
                                label: "–í—Å–µ–≥–æ",
                                show: true,
                                fontSize: "0.75rem",
                                color: "var(--bs-body-color)",
                                fontWeight: 400,
                                formatter: function (w) {
                                    return "100%"
                                }
                            }
                        }
                    }
                }
            },
            states: {
                hover: {
                    filter: {
                        type: "none"
                    }
                },
                active: {
                    filter: {
                        type: "none"
                    }
                }
            }
        };
        
        try {
            new ApexCharts(totalSalesChart, options).render();
            console.log('–î–∏–∞–≥—Ä–∞–º–º–∞ —Å–æ–∑–¥–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ');
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –¥–∏–∞–≥—Ä–∞–º–º—ã:', error);
            totalSalesChart.innerHTML = '<div class="text-center text-danger">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∏–∞–≥—Ä–∞–º–º—ã</div>';
        }
    } else {
        console.log('–≠–ª–µ–º–µ–Ω—Ç totalSalesDonutChart –Ω–µ –Ω–∞–π–¥–µ–Ω');
    }

    // –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏–∞–≥—Ä–∞–º–º—ã —Å—Ç–∞—Ç—É—Å–æ–≤ –∑–∞–∫–∞–∑–æ–≤ (—Ç–∞–∫–∞—è –∂–µ –∫–∞–∫ –û–±—â–∏–µ –ø—Ä–æ–¥–∞–∂–∏)
    const orderStatusChart = document.querySelector("#orderStatusPieChart");
    if (orderStatusChart) {
        // –ß–∏—Ç–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ data-–∞—Ç—Ä–∏–±—É—Ç–æ–≤
        const statusLabels = JSON.parse(orderStatusChart.dataset.labels || '[]');
        const statusValues = JSON.parse(orderStatusChart.dataset.values || '[]');
        const statusColors = JSON.parse(orderStatusChart.dataset.colors || '[]');
        
        // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Å—Ç–∞—Ç—É—Å—ã –≤ —á–∏—Ç–∞–µ–º—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è
        const statusNames = {
            'new': '–ù–æ–≤—ã–µ',
            'new_paid': '–ù–æ–≤—ã–µ –æ–ø–ª–∞—á–µ–Ω–Ω—ã–µ',
            'reserve': '–†–µ–∑–µ—Ä–≤',
            'transfer': '–ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ',
            'delivery': '–î–æ—Å—Ç–∞–≤–∫–∞',
            'callback': '–ü–µ—Ä–µ–∑–≤–æ–Ω–∏—Ç—å',
            'completed': '–í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ',
            'refund': '–í–æ–∑–≤—Ä–∞—Ç',
            'cancelled': '–û—Ç–º–µ–Ω–µ–Ω–Ω—ã–µ'
        };
        
        const labels = statusLabels.map(label => statusNames[label] || label);
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –¥–∏–∞–≥—Ä–∞–º–º—ã
        if (statusValues.length === 0 || statusValues.every(val => val === 0)) {
            console.log('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –¥–∏–∞–≥—Ä–∞–º–º—ã —Å—Ç–∞—Ç—É—Å–æ–≤ –∑–∞–∫–∞–∑–æ–≤');
            orderStatusChart.innerHTML = '<div class="text-center text-muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>';
            return;
        }
        
        const total = statusValues.reduce((a, b) => a + b, 0);
        
        const options = {
            chart: {
                height: 100,
                width: 110,
                parentHeightOffset: 0,
                type: "donut"
            },
            labels: labels,
            series: statusValues,
            colors: statusColors,
            stroke: {
                width: 5,
                colors: ['#fff']
            },
            tooltip: {
                show: false,
                theme: 'light'
            },
            dataLabels: {
                enabled: false,
                formatter: function (val, opts) {
                    return parseInt(val) + "%"
                }
            },
            grid: {
                padding: {
                    top: -10,
                    right: -10,
                    left: -10,
                    bottom: -5
                }
            },
            legend: {
                show: false
            },
            plotOptions: {
                pie: {
                    donut: {
                        size: "75%",
                        labels: {
                            show: true,
                            value: {
                                fontSize: "1.15rem",
                                fontFamily: "Inter",
                                color: "var(--bs-heading-color)",
                                fontWeight: 500,
                                offsetY: -18,
                                formatter: function (val) {
                                    return parseInt(val) + "%"
                                }
                            },
                            name: {
                                offsetY: 18,
                                fontFamily: "Inter"
                            },
                            total: {
                                label: "",
                                label: "–í—Å–µ–≥–æ",
                                show: true,
                                fontSize: "0.75rem",
                                color: "var(--bs-body-color)",
                                fontWeight: 400,
                                formatter: function (w) {
                                    return total.toString()
                                }
                            }
                        }
                    }
                }
            },
            states: {
                hover: {
                    filter: {
                        type: "none"
                    }
                },
                active: {
                    filter: {
                        type: "none"
                    }
                }
            }
        };
        
        try {
            new ApexCharts(orderStatusChart, options).render();
            console.log('–î–∏–∞–≥—Ä–∞–º–º–∞ —Å—Ç–∞—Ç—É—Å–æ–≤ –∑–∞–∫–∞–∑–æ–≤ —Å–æ–∑–¥–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ');
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –¥–∏–∞–≥—Ä–∞–º–º—ã —Å—Ç–∞—Ç—É—Å–æ–≤:', error);
            orderStatusChart.innerHTML = '<div class="text-center text-danger">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∏–∞–≥—Ä–∞–º–º—ã</div>';
        }
    } else {
        console.log('–≠–ª–µ–º–µ–Ω—Ç orderStatusPieChart –Ω–µ –Ω–∞–π–¥–µ–Ω');
    }
});
</script>
{% endblock %}
